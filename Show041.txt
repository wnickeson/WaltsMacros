'MacroName:Show041.2018.01
'MacroDescription:Displays the language codes in an 041 field in a friendly way for
' verification and/or correction. Also compares codes to "Lang" in the fixed field and
' fixes discrepancies.
'
' This macro was written by Walter F. Nickeson,
' University of Rochester, Rochester, NY
' wnickeson@library.rochester.edu
'
' Thanks to Terry Simpkins for clarifying discussion. However, all responsibility for
' this macro's appearance and functionality are mine alone.
'
' Last updated: 20 August 2018.
' Check for the latest versions of this and my other macros at
' https://github.com/wnickeson/WaltsMacros
' Please e-mail me with bug reports or to suggest improvements.
'
' This macro works for me with Connexion client 2.63 and 64-bit Windows 7 Enterprise &
' 64-bit Windows 10 Pro, but no guarantees are promised or implied.
'
'****************************************************************************************
' How it works: Run the macro to display an 041 field in an expanded view with labeled
' subfields, to aid in verification and editing (including some quick error correcting)
' of the field. If the macro is run with the cursor already in an 041 field, that field
' will display; otherwise, the macro displays the first 041 field in the record. If no
' 041 field is present, the macro can help create one. Or run the macro simply to verify
' the code in the fixed field element "Lang". The macro also shows the name of the
' language of cataloging, from the code in 040 $b (supplying the default "English" if
' there is no subfield $b in the 040 field).
'
' The expanded view of the 041 field shows the contents of all the subfields in text
' boxes, allowing for easy addition or deletion of three-letter MARC language codes for
' those subfields. Each subfield's text box also expands to show the language names
' associated with the codes. Edit the boxes directly if language codes are known, or use
' the drop-down list of language names to add codes to a selected subfield. The only
' formatting requirement for input is that multiple language codes in a text box be
' separated by spaces; the macro will appropriately clean up the field in other ways when
' adding or replacing.
'
' The subfields display in the order in which they appear in an existing field; this
' order will be retained after editing, with two exceptions explained below. If a whole
' new field is to be added, the order of the text boxes to be filled in depends upon
' whether or not the item is a musical sound recording (as specified by the value of
' "Type" in the fixed field), and they will all be blank, except that the first text box
' will contain the code in "Lang" in the fixed field, if available.
'
' The macro may re-order subfields in two cases. First, subfields $h, $k, $m, and $n--
' containing language codes of the original and of intermediate translations--follow the
' subfield containing the code(s) of the translation. Second, re-ordering is an option
' presented when the record is for a musical work but in which the language is recorded
' in subfield $a ("Language code of text") rather than $d ("Language code of sung or
' spoken text"). A button allows for quickly moving, if desired, the contents of subfield
' $a into $d. (In the dialog box, the contents of each text box remain in the same
' position, but the labels are switched).
'
' The "Reset" button restores the dialog box to its original display, although some
' changes can't be undone, such as switching the contents of subfields $a and $d.
'
' When adding or replacing a field, the macro formats it as follows: Multiple codes
' concatenated in one subfield (a practice made obsolete in 2001, when all subfields were
' made repeatable) are split, each code being contained in its own subfield. (The macro
' will replace the field even if splitting a string of codes is the only change made,
' unless the "Cancel" button is pressed.) Duplicate language codes are eliminated. Codes
' entered in uppercase are converted to lowercase. Separate subfield sequences (such as
' two subfields $d separated by an intervening subfield $h, for example) are merged into
' one. Language codes in subfields $b, $f, and $j are sorted into alphabetical order (an
' action which will also automatically replace the field); in other subfields, the order
' of the codes as they appear in the field, or as they are entered in the text boxes, is
' preserved. If subfields $h, $k, $m, or $n are present, the first indicator ("Item is or
' includes a translation") is set to "1", but of course whether or not the item is or
' includes a translation should be verified.
'
' The macro checks that all codes are made up of letters only, but it does not verify
' that any particular three-letter sequence is actually a valid MARC language code. It
' compares the code in "Lang" in the fixed field with the first code in the 041 field; if
' they differ, the macro offers quick fix buttons to make either one match the other.
' (Note that the code "mul" in "Lang" does not require that "mul" be the first code in
' subfield $a of the 041 field, as long as "mul" appears somewhere in that subfield). A
' warning displays if the first code in the 041 field is "zxx" (for "No linguistic
' content") and the first subfield is $a.
'
' Finally, the macro works only with fields containing three-letter MARC language codes.
' Fields containing second indicator "7," as a marker for non-MARC codes, are rejected
' for consideration.
'****************************************************************************************

Option Compare Text
Option Explicit

Global Const CRITICAL_MESSAGE     As Integer = 16  'The value to display a "Critical message" (which includes the red button with
                                                   ' a big "X") in a message box; used to report the macro quitting.
Global Const INFORMATION_MESSAGE  As Integer = 64  'The value to display the "Information message" icon in a message box.
Global Const INVISIBLE            As Integer = 0   'The value to make a dialog box control invisible.
Global Const STRING1_EQUAL_TO     As Integer = 0   'The value of the "StrComp" function when strings 1 and 2 are the same.
Global Const STRING1_GREATER_THAN As Integer = 1   'The value of the "StrComp" function when string 1 is greater than string 2.
Global Const STRING1_LESS_THAN    As Integer = -1  'The value of the "StrComp" function when string 1 is less than string 2.
Global Const VISIBLE              As Integer = 1   'The value to make a dialog box control visible.
Global Const WARNING_MESSAGE      As Integer = 48  'The value to display the "Warning message" icon in a message box.

Declare Sub AddLanguageCodeToBox( Selection%, SelectedCode$, SourceOfAddition% )
Declare Sub CompareBoxes        ( WhichBox%, SubmittedText$ )
Declare Sub InitializeDialog2Definition
Declare Sub LinkCodesToNames    ( StringIn$ )
Declare Sub SetLanguageArrays
Declare Sub SetupCodeArrays
Declare Sub SetupTextBoxes
Declare Sub SwapDisplayListBox  ( SelectedTextBox% )

Declare Function FormatSubfields( StringIn$, Code$ )              As String
Declare Function GetSubfieldCode( StringIn$ )                     As String
Declare Function SplitCodeString( StringIn$, Code$, SortNeeded% ) As String
Declare Function ValidateInput  ( StringIn$ )                     As String

Declare Function Dialog1ControlFunction( Id$, Action%, SVal& )
Declare Function Dialog2ControlFunction( Id$, Action%, SVal& )

Const aCOUNT_ELEMENTS        As Integer = 5    'The upper bound of the second dimension of the array holding subfield data (see below).
Const aCOUNT_SUBFIELDS       As Integer = 6    'The upper bound of the first dimension of the array holding subfield data (seven subfields: $a, $b, $d, $e, $f, $g, $j ).
Const aLANG_CODES_INTERMS    As Integer = 2    'The value of the subscript of the array that contains the contents of subfield $k, language(s) of intermediate translations.
Const aLANG_CODES_ORIGS      As Integer = 3    'The value of the subscript of the array that contains the contents of subfields $h, language(s) of the original.
Const aLANG_CODES_PRIMARY    As Integer = 1    'The value of the subscript of the array that contains the contents of all subfields except $h, $k, $m, and $n.
Const aSUBFIELD_CODE_ORIGS   As Integer = 4    'The value of the subscript of the array that contains the subfield code of the language codes for the original.
Const aSUBFIELD_CODE_PRIMARY As Integer = 0    'The value of the subscript of the array that contains the subfield codes, both used and unused.
Const aSUBFIELD_DEFN         As Integer = 5    'The value of the subscript of the array that contains the definitions of the subfields.
Const FILL_CHAR              As Integer = 252  'The ASCII value of the fill character as used by OCLC.
Const FROM_LANG_LIST         As Integer = 1    'The value indicating that the added text in a text box came from the list of languages.
Const ID_FIRST_TEXT_BOX      As Integer = 8    'The numeric ID of the first text box (Subf1) in the main dialog box.
Const ID_LAST_TEXT_BOX       As Integer = 28   'The numeric ID of the last text box (Subf7H) in the main dialog box.
Const ID_POST_TEXT_BOXES     As Integer = 29   'The numeric ID of the first dialog control after the last text box in the main dialog box.
Const ID_PRE_TEXT_BOXES      As Integer = 7    'The numeric ID of the last dialog control before the first text box in the main dialog box.
Const INITIALIZE             As Integer = 1    'The value of the dialog box function parameter "Action%" when the dialog box opens..
Const LANGUAGE_CODES_COUNT   As Integer = 484  'The number of languages and language codes in each array.
Const LANG_CODE_LENGTH       As Integer = 3    'The length (in characters) of a MARC language code.
Const WARN_DUPS              As Integer = 32   'The value of the warning code that language codes are duplicated in a subfield.
Const WARN_INSERT            As Integer = 2    'The value of the warning code to enable insertion of language code from fixed field.
Const WARN_MATCH             As Integer = 4    'The value of the warning code that Lang and 041 don't match.
Const WARN_SORT              As Integer = 8    'The value of the warning code that language codes will be sorted in subfields $b or $f.
Const WARN_SPLIT             As Integer = 16   'The value of the warning code that language codes in a subfield will be separated.
Const WARN_SWITCH            As Integer = 1    'The value of the warning code to enable switching of subfields $a and $d.

Global CS As Object

Global Addition$
Global CurrentControl%
Global Duplicates$
Global FFLangDisplay$
Global FF_Lang$
Global FF_Type$
Global FixCodingErrors%  ' "FixCodingErrors%" is a sum of values that govern message display for various coding errors that the macro will fix automatically
'                            8  = WARN_SORT   = Codes out of alphabetical order in subfields $b, $f, or $j.
'                            16 = WARN_SPLIT  = Codes need to be split apart in one or more subfields.
'                            32 = WARN_DUPS   = Duplicate codes found in a subfield.
Global FixLogicErrors%   ' "FixLogicErrors%" is a sum of values that govern message display for various (possible) logic errors that the macro will fix upon user confirmation
'                            1  = WARN_SWITCH = Field contains data in $a or $d (but not both), possibly a problem for certain formats.
'                            2  = WARN_INSERT = Field contains neither $a nor $d, possibly a problem for a musical sound recording.
'                            4  = WARN_MATCH  = Mismatch between code in Lang and the first code in 041.
Global InitialFocus%
Global ListLegendBase$
Global MsgDups$
Global MsgInsert$
Global MsgMatch$
Global MsgSort$
Global MsgSplit$
Global MsgSwitch$
Global MultipleCodes$
Global PosSubfA%
Global PosSubfD%
Global PreviousControl%
Global PreviousTextbox%
Global Subf1$
Global Subf1H$
Global Subf1K$
Global Subf2$
Global Subf2H$
Global Subf2K$
Global Subf3$
Global Subf3H$
Global Subf3K$
Global Subf4$
Global Subf4H$
Global Subf4K$
Global Subf5$
Global Subf5H$
Global Subf5K$
Global Subf6$
Global Subf6H$
Global Subf6K$
Global Subf7$
Global Subf7H$
Global Subf7K$
Global SubfieldsUsed$
Global TempArrayElements%
Global WaltsMacros$

Global DELIMITER    As String*1
Global DOUBLE_QUOTE As String*1

Global Change
Global ChangeFF
Global KeepDlgOpen
Global Lang041Match
Global SortCodesB
Global SortCodesF
Global SortCodesJ
Global Update

Global CodesNames1()  As String
Global CodesNames1H() As String
Global CodesNames1K() As String
Global CodesNames2()  As String
Global CodesNames2H() As String
Global CodesNames2K() As String
Global CodesNames3()  As String
Global CodesNames3H() As String
Global CodesNames3K() As String
Global CodesNames4()  As String
Global CodesNames4H() As String
Global CodesNames4K() As String
Global CodesNames5()  As String
Global CodesNames5H() As String
Global CodesNames5K() As String
Global CodesNames6()  As String
Global CodesNames6H() As String
Global CodesNames6K() As String
Global CodesNames7()  As String
Global CodesNames7H() As String
Global CodesNames7K() As String

Global LanguageCodes( LANGUAGE_CODES_COUNT )              As String
Global LanguageNames( LANGUAGE_CODES_COUNT )              As String
Global Subfields    ( aCOUNT_SUBFIELDS, aCOUNT_ELEMENTS ) As String
' Each row of this array contains one of the seven subfields $a, $b, $d, $e, $f, $g, and $j. The elements of each row are:
'  0  aSUBFIELD_CODE_PRIMARY  The subfield code.
'  1  aLANG_CODES_PRIMARY     The language codes in that subfield.
'  2  aLANG_CODES_INTERMS     The language codes in subfield $k that correspond to the codes in the primary subfield.
'  3  aLANG_CODES_ORIGS       The language codes in subfields $h, $m, and $n that correspond to the codes in the primary subfield.
'  4  aSUBFIELD_CODE_ORIGS    The subfield code (either $h, $m, or $n) for the language codes of the original material.
'  5  aSUBFIELD_DEFN          The definition of the subfield.
Global TempArray    ()                                    As String

'****************************************************************************************

Sub Main

Const DIALOG_BUTTON_CANCEL As Integer = 102  'The value returned by the dialog box when the "Cancel" button is clicked.

Set CS = CreateObject("Connex.Client")

Dim AllSubfields$
Dim Answer%
Dim CatLang$
Dim CatSource$
Dim DataCurrent$
Dim DataToAdd$
Dim DlgTitle$
Dim DupCode$
Dim FieldData$
Dim FirstLangCode$
Dim Ind1$
Dim Ind2$
Dim Instructions1$
Dim Instructions2$
Dim Instructions3$
Dim LangString$
Dim ListString$
Dim NewField$
Dim NextDelimiter%
Dim PosFF%
Dim Row%
Dim SortNeeded%
Dim Start%
Dim SubfieldCode$
Dim SubfieldsContents$
Dim SubfieldsMusic$          : SubfieldsMusic$    = "dbegfaj"
Dim SubfieldsNonMusic$       : SubfieldsNonMusic$ = "abgefjd"
Dim SubfieldsUnused$
Dim Tag$
Dim TypeOfWindow%
Dim WorkformTest$

Dim AddNew                   : AddNew             = FALSE
Dim Found041                 : Found041           = FALSE
Dim In041                    : In041              = FALSE

Dim i As Integer, j As Integer, p As Integer, q As Integer

DELIMITER       = Chr$( 223 )
DOUBLE_QUOTE    = Chr$( 034 )
InitialFocus%   = ID_FIRST_TEXT_BOX
Instructions1$  = "Click in a text box to view language names and to add, change, or delete language codes. "
Instructions1$  = Instructions1$ & "Separate multiple language codes in a subfield with a space."
Instructions2$  = "Or, select a code from this list of languages to add to the subfield in which the cursor is located:"
Instructions3$  = "Click " & DOUBLE_QUOTE & "Update form" & DOUBLE_QUOTE & " to view language names after adding codes."
ListLegendBase$ = "Language names in "
WaltsMacros$    = "[Walt's macros] Extras1:Show041"

Change          = FALSE
ChangeFF        = FALSE
KeepDlgOpen     = FALSE
Lang041Match    = TRUE
SortCodesB      = FALSE
SortCodesF      = FALSE
SortCodesJ      = FALSE
Update          = FALSE

' First: Is the cursor in an 041 field? If so, get that field for processing.

Row% = CS.CursorRow
If CS.GetFieldLine( Row%, FieldData$ ) Then
    Tag$ = Left$( FieldData$, 3 )
    If Tag$ = "041" Then
        Ind2$      = Mid$( FieldData$, 5, 1 )
        If Ind2$ = "7" Then
            MsgBox "Sorry, this macro deals only with MARC language codes.", CRITICAL_MESSAGE, WaltsMacros$
            Exit Sub
        End If
        Ind1$      = Mid$( FieldData$, 4, 1 )
        FieldData$ = Mid$( FieldData$, 6 )
        Found041   = TRUE
        In041      = TRUE
      Else

' If the cursor is NOT in an 041 field, verify that a bibliographic record is open; exit
' the macro if one is not.

        TypeOfWindow% = CS.ItemType
        Select Case TypeOfWindow%
          Case 0, 1, 17, 35
          Case Else
            MsgBox "this macro works only in a bibliographic record!", CRITICAL_MESSAGE, WaltsMacros$
            Exit Sub
          End Select
    End If
End If

' Proceed by getting some fixed field values, which may mean altering and then restoring
' display of the fixed field. If the fixed field values being sought are unavailable or
' are fill characters, give them dummy values using the digit "9" (safe because the
' allowable values are letters).

PosFF% = CS.FixedFieldPosition
If PosFF% <> 1 Then CS.FixedFieldPosition = 1

If CS.GetFixedField( "Type", FF_Type$ ) Then
    If Asc( FF_Type$ ) = FILL_CHAR Then
        FF_Type$ = "9"
    End If
  Else
    FF_Type$ = "9"
End If
If CS.GetFixedField( "Lang", FF_Lang$ ) Then
    If Asc( Left$( FF_Lang$, 1 ) ) = FILL_CHAR Then
        FF_Lang$ = "999"
    End If
  Else
    FF_Lang$ = "999"
End If

CS.FixedFieldPosition = PosFF%

If CS.GetField( "040", 1, CatSource$ ) Then
    p = InStr( CatSource$, DELIMITER & "b" )
    If p > 0 Then
        CatLang$ = Trim$( Mid$( CatSource$, p + 3, LANG_CODE_LENGTH ) )
      Else
        CatLang$ = ""
    End If
End If

' Fill the two language arrays.

SetLanguageArrays

If CatLang$ <> "" Then
    LinkCodesToNames( CatLang$ )
    CatLang$ = TempArray( 0 )
  Else
    CatLang$ = "[English]"
End If
CatLang$ = "Language of cataloging: " & CatLang$

' Set up the display of the name of the language coded in the fixed field (Leader
' 008/35-37), if available.

If FF_Lang$ <> "999" Then
    LinkCodesToNames( FF_Lang$ )
    FFLangDisplay$ = TempArray( 0 )
    FFLangDisplay$ = "Fixed field Lang: " & Trim$( FFLangDisplay$ )
  Else
    FFLangDisplay$ = "Fixed field Lang: [unavailable]"
End If

' Then get the first 041 field. If there is none, ask if one should be created, and if
' the answer is yes, jump down to the appropriate section of the macro. The dialog box
' containing this question also shows the name of the language encoded in the fixed
' field, as an aid to identification of unknown codes.

If Found041 = FALSE Then
    If CS.GetField( "041", 1, FieldData$ ) = FALSE Then

        Begin Dialog Dialog1Definition 184, 112, WaltsMacros$, .Dialog1ControlFunction
          ButtonGroup .Continue
           PushButton    20, 32,  64, 20, "&Yes"
           PushButton   100, 32,  64, 20, "&No"
           CancelButton 1, 1, 1, 1
          Text           40, 12, 104,  8, "No 041 field found! Create one?"
          Text           20, 64, 144, 16, FFLangDisplay$
          Text           20, 82, 144, 16, CatLang$
        End Dialog

        Dim Dialog1 As Dialog1Definition
        On Error Resume Next
        Dialog Dialog1
        If Err = DIALOG_BUTTON_CANCEL Then Exit Sub

        If Dialog1.Continue = 0 Then
            AddNew = TRUE
            GoTo AddField:
          Else
            Exit Sub
        End If
      Else

' If an 041 field is found, first see if it's empty, as it will be on a workform. If it
' is, jump down to the section to add a new field. Otherwise, proceed by checking the
' second indicator to make sure the field contains only MARC codes.

        WorkformTest$ = Mid$( FieldData$, 6 )
        Do
          p = InStr( WorkformTest$, DELIMITER )
          If p <> 0 Then
              WorkformTest$ = Left$( WorkformTest$, p - 1 ) & Mid$( WorkformTest$, p + 2 )
          End If
        Loop Until p = 0
        If Trim$( WorkformTest$ ) = "" Then
            AddNew = TRUE
            GoTo AddField:
        End If
        Tag$ = Left$( FieldData$, 3 )
        If Tag$ = "041" Then
            Ind2$      = Mid$( FieldData$, 5, 1 )
            If Ind2$ = "7" Then
                MsgBox "Sorry, this macro deals only with MARC language codes.", CRITICAL_MESSAGE, WaltsMacros$
                Exit Sub
            End If
            Ind1$      = Mid$( FieldData$, 4, 1 )
            FieldData$ = Trim$( Mid$( FieldData$, 5 ) )
            Found041   = TRUE
        End If
    End If
End If

' To aid in processing, make sure the field begins with a delimiter and "a", which OCLC
' hides by default if the first subfield is "a".

If Left$( FieldData$, 1 ) <> DELIMITER Then
    FieldData$ = DELIMITER & "a " & FieldData$
End If

' Break up the field into its constituent subfields. Store the data in a two-dimensional
' array. One dimension identifies the seven primary subfields, while the other stores
' pieces of information about each subfield, as described above.

Start%         = 1
NextDelimiter% = 1
Do
  i = InStr( Start%, FieldData$, DELIMITER )
  If i <> 0 Then

' If a delimiter is found, look ahead to the next one (or to the end of the field), and
' take the text string between the two occurrences for manipulation

      NextDelimiter% = InStr( i + 1, FieldData$, DELIMITER )
      If NextDelimiter% = 0 Then
          NextDelimiter% = Len( FieldData$ ) + 2
      End If
      LangString$    = Mid$( FieldData$, i, NextDelimiter% - 1 - i )
      SubfieldCode$  = Mid$( LangString$, 2, 1 )
      LangString$    = Trim$( Mid$( LangString$, LANG_CODE_LENGTH ) )

' Each unique subfield is stored in one element of the first dimension of the array. It is followed by
' the contents of subfield $k, intermediate translations, and then by the contents of the subfields
' of the original language(s)--subfields $h, etc.

      If SubfieldCode$ Like "[abdefgj]" Then

' Process the field and fill the array. For each subfield, starting with the first
' element (index zero), check the array for any contents of that element. If there are
' none, insert the subfield data, that is, enter the subfield code and the language code.
' If an element already contains data, compare the subfield codes. If they differ,
' increment the index to test the next element. If they match, append the incoming
' language codes to the existing ones. But also test to see if other subfields have
' intervened. This is done via the variable "SubfieldsUsed$", which is simply a string to
' which each unique subfield code found is appended; if a subfield code is found to have
' already been stored in the array, but that code is not the last code in
' "SubfieldsUsed$", that is an indicator that subfields have been repeated out of order
' and that merging will be required. In such a case, the field is marked as changed for
' replacement. The macro combines all occurrences of any subfield (except subfields $h,
' etc. that follow different subfields), so even though the content of the field may be
' unchanged, it may have to be rearranged. Any duplicate codes not caught here will be
' eliminated when the replacement field is constructed. Finally, in subfields $b, $f, and
' $j, check for alphabetical order as codes are added. If the codes are not in order,
' they will need to be sorted, and the display in the main dialog box will reflect that.

          For j = 0 To aCOUNT_SUBFIELDS
            If Subfields( j, aSUBFIELD_CODE_PRIMARY ) = "" Then              'Empty array element: add data
                Subfields( j, aSUBFIELD_CODE_PRIMARY ) = SubfieldCode$
                SubfieldsUsed$                         = SubfieldsUsed$ & SubfieldCode$

' The primary duty of the function "SplitCodeString" is to separate language codes that have
' been input as one string instead of several. However, the function also keeps track of
' which subfield codes have been used, and whether or not the language codes in any
' particular subfield are in alphabetical order, although that fact (stored in the
' variable "SortNeeded%") is relevant only for subfields $b, $f, and $j.

                SortNeeded%                         = 0                'Initial value: Language codes are in order
                Subfields( j, aLANG_CODES_PRIMARY ) = SplitCodeString( LangString$, SubfieldCode$, SortNeeded% ) & " "

' If the language codes are not in alphabetical order in subfields $b, $f, or $j,
' determine which needs to be sorted, and change the value of the "FixLogicErrors%" flag.

                If SortNeeded% = 1 Then
                    If SubfieldCode$ = "b" Then
                        SortCodesB = TRUE
                      ElseIf SubfieldCode$ = "f" Then
                        SortCodesF = TRUE
                      ElseIf SubfieldCode$ = "j" Then
                        SortCodesJ = TRUE
                    End If
                End If
                Exit For
              Else                 'Array element already used: Add data to same subfield only
                If InStr( Subfields( j, aSUBFIELD_CODE_PRIMARY ), SubfieldCode$ ) <> 0 Then         'Same subfield
                    DataCurrent$ = Subfields( j, aLANG_CODES_PRIMARY )
                    SortNeeded%  = 0
                    DataToAdd$   = SplitCodeString( LangString$, SubfieldCode$, SortNeeded% )

' If a code is not already stored, add it.

                    If InStr( DataCurrent$, DataToAdd$ ) = 0 Then
                        Subfields( j, aLANG_CODES_PRIMARY ) = DataCurrent$ & DataToAdd$ & " "
                        If SubfieldCode$ <> Right$( SubfieldsUsed$, 1 ) Then
                            Change = TRUE
                        End If

' If codes are out of alphabetical order in subfields $b, $f, or $j, raise a flag.

                        If StrComp( Right$( Trim$( DataCurrent$ ), 3 ), DataToAdd$ ) = STRING1_GREATER_THAN Then
                            If SubfieldCode$ = "b" Then
                                SortCodesB = TRUE
                              ElseIf SubfieldCode$ = "f" Then
                                SortCodesF = TRUE
                              ElseIf SubfieldCode$ = "j" Then
                                SortCodesJ = TRUE
                            End If
                        End If

' If a code is already stored in the subfield, it won't be added again, thus the field
' will be replaced, and a flag is raised. Keep track of which subfields the duplicate
' codes were in for the notification in the dialog box.

                      Else
                        If InStr$( DupCode$, SubfieldCode$ ) = 0 Then
                            DupCode$ = DupCode$ & SubfieldCode$
                        End If
                        Change = TRUE
'                        Duplicates$ = Duplicates$ & " " & DataToAdd$
                    End If
                    Exit For
                End If
            End If
          Next j
        ElseIf SubfieldCode$ Like "[hkmn]" Then

' For language codes of originals or intermediate translations (subfields $h, $k, $m, and
' $n), the contents of the subfield are stored with the subfield they follow, so they are
' simply added as the third and fourth elements at the index of the current subfield.

          SortNeeded% = 0
          If SubfieldCode$ = "k" Then
              If InStr( Subfields( j, aLANG_CODES_INTERMS ), LangString$ ) = 0 Then
                  Subfields( j, aLANG_CODES_INTERMS ) = Subfields( j, aLANG_CODES_INTERMS ) & SplitCodeString( LangString$, SubfieldCode$, SortNeeded% ) & " "
              End If
            Else
              If InStr( Subfields( j, aLANG_CODES_ORIGS ), LangString$ ) = 0 Then
                  Subfields( j, aLANG_CODES_ORIGS )   = Subfields( j, aLANG_CODES_ORIGS ) & SplitCodeString( LangString$, SubfieldCode$, SortNeeded% ) & " "
              End If
          End If
        ElseIf SubfieldCode$ Like "[!268]" Then
          MsgBox "Unrecognized subfield " & SubfieldCode$ & "!", CRITICAL_MESSAGE, WaltsMacros$
          Exit Sub
      End If
  End If
  Start% = i + 1
Loop Until i = 0

' Increment the warning code

If SortCodesB = TRUE Or SortCodesF = TRUE or SortCodesJ = TRUE Then
    FixCodingErrors% = FixCodingErrors% + WARN_SORT
End If

If DupCode$ <> "" Then
    FixCodingErrors% = FixCodingErrors% + WARN_DUPS
End If

' Check for the occurrence of subfields $d and $a; depending on the type of record, their
' presence or absence may be incorrect.

p = InStr( SubfieldsUsed$, "d" )
q = InStr( SubfieldsUsed$, "a" )

If p = 0 And q = 0 Then                          'Nothing in $d, nothing in $a
    If FF_Lang$ <> "zxx" Then                       'Lang known: Insert from FF?
        FixLogicErrors% = FixLogicErrors% + WARN_INSERT
    End If
  ElseIf p = 0 And q > 0 Then                    'Nothing in $d, something in $a
    If FF_Lang$ <> "zxx" Then                       'Lang known
        If FF_Type$ = "j" Then                        'Music: Switch $a and $d?
            FixLogicErrors% = FixLogicErrors% + WARN_SWITCH
        End If
    End If
  ElseIf p > 0 And q = 0 Then                    'Nothing in $a, something in $d
    If FF_Lang$ <> "zxx" Then                       'Lang known
        If FF_Type$ <> "j" Then                       'Non-Music: Switch $d and $a?
            FixLogicErrors% = FixLogicErrors% + WARN_SWITCH
        End If
      Else                                       'Lang is "zxx" but 041 $d is something
        If p = 1 And Subfields( aSUBFIELD_CODE_PRIMARY, aLANG_CODES_PRIMARY ) <> "zxx" Then
            FixLogicErrors% = FixLogicErrors% + WARN_MATCH
        End If
    End If
  Else                                           'Something in $a and $d: Shouldn't happen
End If

' When the record type is known the error messages and warnings can be set.

Select Case Len( DupCode$ )
  Case 1
    MsgDups$   = "Duplicate language codes were removed from subfield $" & DupCode$ & "."
  Case 2
    MsgDups$   = "Duplicate language codes were removed from subfields $" & Left$( DupCode$, 1 ) & " and $" & Mid$( DupCode$, 2 ) & "."
  Case 3
    MsgDups$   = "Duplicate language codes were removed from subfields $" & Left$( DupCode$, 1 ) & ", $" & Mid$( DupCode$, 2 ) & ", and " & Mid$( DupCode$, 3 ) & "."
  Case Else
    MsgDups$   = "Duplicate language codes were removed from four or more subfields."
End Select
If FF_Type$ = "j" Then
    MsgInsert$ = "This record is for a musical work, but there is no subfield $d. "
    MsgInsert$ = MsgInsert$ & "Click the button to insert subfield $d from the language code in the fixed field."
  Else
    MsgInsert$ = "This record contains no subfield $a. "
    MsgInsert$ = MsgInsert$ & "Click the button to insert subfield $a from the language code in the fixed field."
End If
MsgMatch$      = "The language code in the fixed field does not match the first code in the 041. "
MsgMatch$      = MsgMatch$ & "Click one of these buttons to quickly fix the problem."
If FF_Type$ = "j" Then
    MsgSwitch$ = "This record is for a musical work, so the first subfield should probably be $d, "
    MsgSwitch$ = MsgSwitch$ & "rather than $a. Switch the contents of subfields $a and $d?"
  Else
    MsgSwitch$ = "This record is not for a musical work, so the first subfield should probably be $a, "
    MsgSwitch$ = MsgSwitch$ & "rather than $d. Switch the contents of subfields $d and $a?"
End If

If FF_Type$ = "j" Then
    AllSubfields$ = SubfieldsMusic$
  Else
    AllSubfields$ = SubfieldsNonMusic$
End If

' Generate a list of the unused subfields and fill the remainder of the array with the
' unused subfield codes, in order to label the text boxes in the dialog box.

For i = 1 To aCOUNT_SUBFIELDS + 1
  SubfieldCode$ = Mid$( AllSubfields$, i, 1 )
  p             = InStr( SubfieldsUsed$, SubfieldCode$ )
  If p = 0 Then
      SubfieldsUnused$ = SubfieldsUnused$ & SubfieldCode$
  End If
Next i

p = Len( SubfieldsUsed$ )
For i = 1 To Len( SubfieldsUnused$ )
  Subfields( p, aSUBFIELD_CODE_PRIMARY ) = Mid$( SubfieldsUnused$, i, 1 )
  p = p + 1
Next i

AddField:

' If a completely new field is to be added, some of the text of the dialog box will vary,
' and the order of the subfields presented in the dialog box needs to be set; this is
' determined by the type of record.

If AddNew = TRUE Then
    DlgTitle$          = "[Macro Essentials:Show041 (Beta)] :: Add 041 field"
    SubfieldsContents$ = "Enter language codes:"
    Tag$               = "041"
    Ind1$              = "0"
    Ind2$              = " "
    For i = 0 To 6
      If FF_Type$ = "j" Then
          Subfields( i, aSUBFIELD_CODE_PRIMARY ) = Mid$( SubfieldsMusic$, i + 1, 1 )
        Else
          Subfields( i, aSUBFIELD_CODE_PRIMARY ) = Mid$( SubfieldsNonMusic$, i + 1, 1 )
      End If
    Next i
    If FF_Lang$ <> "999" And FF_Lang$ <> "zxx" Then
        Subfields( 0, aLANG_CODES_PRIMARY ) = FF_Lang$
    End If
    ReDim CodesNames1 ( 0 )
    ReDim CodesNames1H( 0 )
    ReDim CodesNames1K( 0 )
    ReDim CodesNames2 ( 0 )
    ReDim CodesNames2H( 0 )
    ReDim CodesNames2K( 0 )
    ReDim CodesNames3 ( 0 )
    ReDim CodesNames3H( 0 )
    ReDim CodesNames3K( 0 )
    ReDim CodesNames4 ( 0 )
    ReDim CodesNames4H( 0 )
    ReDim CodesNames4K( 0 )
    ReDim CodesNames5 ( 0 )
    ReDim CodesNames5H( 0 )
    ReDim CodesNames5K( 0 )
    ReDim CodesNames6 ( 0 )
    ReDim CodesNames6H( 0 )
    ReDim CodesNames6K( 0 )
    ReDim CodesNames7 ( 0 )
    ReDim CodesNames7H( 0 )
    ReDim CodesNames7K( 0 )
  Else
    DlgTitle$          = "[Macro Essentials:Show041 (Beta)] :: Edit 041 field"
    SubfieldsContents$ = "Edit language codes:"
End If

' Add the definitions of the subfields to the array for display. Definitions are stored
' with the subfield data because the display of the subfields in the dialog box is not
' fixed; it varies with the contents of the field or the type of record, so the
' definitions don't appear in the same place for every bibliographic record. This routine
' also marks where subfields $e and $g occur, as codes for the original languages or
' intermediate translations stored in subfields other than $h.

For i = 0 To aCOUNT_SUBFIELDS
  Select Case Subfields( i, aSUBFIELD_CODE_PRIMARY )
    Case "a"
      Subfields( i, aSUBFIELD_DEFN )       = "Language code of text/sound-track or separate title"
      Subfields( i, aSUBFIELD_CODE_ORIGS ) = "h"
      PosSubfA% = i
    Case "b"
      Subfields( i, aSUBFIELD_DEFN )       = "Language code of summary or abstract"
      Subfields( i, aSUBFIELD_CODE_ORIGS ) = "m"
    Case "d"
      Subfields( i, aSUBFIELD_DEFN )       = "Language code of sung or spoken text"
      Subfields( i, aSUBFIELD_CODE_ORIGS ) = "h"
      PosSubfD% = i
    Case "e"
      Subfields( i, aSUBFIELD_DEFN )       = "Language code of librettos"
      Subfields( i, aSUBFIELD_CODE_ORIGS ) = "n"
    Case "f"
      Subfields( i, aSUBFIELD_DEFN )       = "Language code of table of contents"
      Subfields( i, aSUBFIELD_CODE_ORIGS ) = "h"
    Case "g"
      Subfields( i, aSUBFIELD_DEFN )       = "Language code of accompanying material other than librettos"
      Subfields( i, aSUBFIELD_CODE_ORIGS ) = "m"
    Case "j"
      Subfields( i, aSUBFIELD_DEFN )       = "Language code of subtitles or captions"
      Subfields( i, aSUBFIELD_CODE_ORIGS ) = "h"
  End Select
Next i

' If a single subfield contains multiple language codes, they will be separated, even if
' that is the only action the macro takes. All such subfields are stored in the variable
' "MultipleCodes$", which this next section of the macro expands to display nicely a note
' about the dissection undertaken by this macro. In this note, subfield $h always comes
' last.

p = InStr( MultipleCodes$, "h" )

Select Case Len( MultipleCodes$ )
  Case 0
  Case 1
    MultipleCodes$ = "subfield $" & MultipleCodes$
  Case 2
    If p = 1 Then
        MultipleCodes$ = Right$( MultipleCodes$, 1 ) & "h"
    End If
    MultipleCodes$ = "subfields $" & Left$( MultipleCodes$, 1 ) & " and $" & Right$( MultipleCodes$, 1 )
  Case Else
    If p = 1 Then
        MultipleCodes$ = Mid$( MultipleCodes$, 2 ) & "h"
      ElseIf p > 1 Then
        MultipleCodes$ = Left$( MultipleCodes$, p - 1 ) & Mid$( MultipleCodes$, p + 1 ) & "h"
    End If
    For i = 1 To Len( MultipleCodes$ ) - 1
      ListString$ = ListString$ & "$" & Mid$( MultipleCodes$, i, 1 ) & ", "
    Next i
    MultipleCodes$ = "subfields " & ListString$ & "and $" & Right$( MultipleCodes$, 1 ) & ","
End Select

If Len( MultipleCodes$ ) > 0 Then
    FixCodingErrors% = FixCodingErrors% + WARN_SPLIT
End If

MsgSplit$ = "Pressing " & DOUBLE_QUOTE & "OK" & DOUBLE_QUOTE & " will separate all language codes in " & MultipleCodes$
MsgSplit$ = MsgSplit$ & " and replace the 041 field, even if no other changes are made."

' Check that the code in the fixed field element "Lang" is the same as the first code in
' the 041. Two cases where a difference is allowed: 1) if "Lang" is "mul" and "mul" also
' appears somewhere in subfield $a in the 041, or 2) the record is for a musical sound
' recording and the language code in the fixed field is "zxx," indicating no sung or
' spoken text.

If FF_Lang$ <> "999" Then
    If FF_Lang$ <> Left$( Subfields( 0, aLANG_CODES_PRIMARY ), LANG_CODE_LENGTH ) Then
        If FF_Lang$ = "mul" Then
            If InStr( Subfields( 0, aLANG_CODES_PRIMARY ), "mul" ) = 0 Then
                Lang041Match = FALSE
            End If
          ElseIf FF_Lang$ = "zxx" Then
            If FF_Type$ <> "j" Then
                Lang041Match = FALSE
            End If
          Else
            Lang041Match = FALSE
        End If
    End If
End If

If Lang041Match = FALSE Then
    FixLogicErrors% = FixLogicErrors% + WARN_MATCH
End If

' When the dialog box opens the first time, the contents of the subfield boxes come from
' the "Subfields" array; subsequent times they come from the text boxes themselves, so
' "SetupTextBoxes" must run only once.

Call SetupTextBoxes

Recycle:

Call SetupCodeArrays

Begin Dialog Dialog2Definition 512, 456, WaltsMacros$, .Dialog2ControlFunction
  ButtonGroup .Choice
   PushButton   400, 414,  96,  24, "&OK",           .OK               '1    <-- Ids of controls
   PushButton   280, 414,  96,  24, "&Cancel"                          '2
   PushButton   260, 256,  72,  16, "&Update form",  .Update           '3
   PushButton   376, 304,  48,  16, "",              .WarningButton1   '4
   PushButton   434, 304,  48,  16, "",              .WarningButton2   '5
   CancelButton  1, 13, 1, 1
  DropListBox   188, 234, 144,  96, LanguageNames(), .LanguageList     '7
  TextBox       160,  55, 144,  12,                  .TextBox1         '8
  TextBox       328,  55,  72,  12,                  .TextBox1K        '9
  TextBox       424,  55,  72,  12,                  .TextBox1H        '10
  TextBox       160,  75, 144,  12,                  .TextBox2         '11
  TextBox       328,  75,  72,  12,                  .TextBox2K        '12
  TextBox       424,  75,  72,  12,                  .TextBox2H        '13
  TextBox       160,  95, 144,  12,                  .TextBox3         '14
  TextBox       328,  95,  72,  12,                  .TextBox3K        '15
  TextBox       424,  95,  72,  12,                  .TextBox3H        '16
  TextBox       160, 115, 144,  12,                  .TextBox4         '17
  TextBox       328, 115,  72,  12,                  .TextBox4K        '18
  TextBox       424, 115,  72,  12,                  .TextBox4H        '19
  TextBox       160, 135, 144,  12,                  .TextBox5         '20
  TextBox       328, 135,  72,  12,                  .TextBox5K        '21
  TextBox       424, 135,  72,  12,                  .TextBox5H        '22
  TextBox       160, 155, 144,  12,                  .TextBox6         '23
  TextBox       328, 155,  72,  12,                  .TextBox6K        '24
  TextBox       424, 155,  72,  12,                  .TextBox6H        '25
  TextBox       160, 175, 144,  12,                  .TextBox7         '26
  TextBox       328, 175,  72,  12,                  .TextBox7K        '27
  TextBox       424, 175,  72,  12,                  .TextBox7H        '28
  ListBox       344, 222, 140,  56, "",              .SubfieldContents
  Text          344, 210, 140,   8, "",              .ListLegend
  Text           20,  54,   8,   8, "",              .LabelCode1
  Text           30,  54, 124,  16, "",              .LabelDefn1
  Text           20,  74,   8,   8, "",              .LabelCode2
  Text           30,  74, 124,  16, "",              .LabelDefn2
  Text           20,  94,   8,   8, "",              .LabelCode3
  Text           30,  94, 124,  16, "",              .LabelDefn3
  Text           20, 114,   8,   8, "",              .LabelCode4
  Text           30, 114, 124,  16, "",              .LabelDefn4
  Text           20, 134,   8,   8, "",              .LabelCode5
  Text           30, 134, 124,  16, "",              .LabelDefn5
  Text           20, 154,   8,   8, "",              .LabelCode6
  Text           30, 154, 124,  16, "",              .LabelDefn6
  Text           20, 174,   8,   8, "",              .LabelCode7
  Text           30, 174, 124,  16, "",              .LabelDefn7
  Text          318,  56,   8,   8, "k"
  Text          318,  76,   8,   8, "k"
  Text          318,  96,   8,   8, "k"
  Text          318, 116,   8,   8, "k"
  Text          318, 136,   8,   8, "k"
  Text          318, 156,   8,   8, "k"
  Text          318, 176,   8,   8, "k"
  Text          414,  56,   8,   8, "",              .OrigLang1
  Text          414,  76,   8,   8, "",              .OrigLang2
  Text          414,  96,   8,   8, "",              .OrigLang3
  Text          414, 116,   8,   8, "",              .OrigLang4
  Text          414, 136,   8,   8, "",              .OrigLang5
  Text          414, 156,   8,   8, "",              .OrigLang6
  Text          414, 176,   8,   8, "",              .OrigLang7
  Text           16,  12, 256,   8, "",              .LangFF
  Text           16,  40,  28,   8, "Subfield:"
  GroupBox      159,  23, 338,  27, ""
  Text          164,  38, 120,   8, "Language codes of primary material:" 'SubfieldsContents$
  Text          318,  30,  80,  16, "Language codes of intermediate translations:"
  Text          414,  30,  70,  16, "Language codes of original:"
  GroupBox       16, 198, 480,  86, "Add/edit language codes"
  Text           26, 210, 306,  16, Instructions1$
  Text           26, 232, 158,  16, Instructions2$
  Text           26, 260, 216,   8, Instructions3$
  GroupBox       16, 292, 480, 108, "Messages: ",    .WarningBox
  Text           26, 306, 344,  16, "",              .WarningText1
  Text           26, 306, 344,  16, "",              .WarningText2
  Text           26, 342, 456,   8, "",              .WarningText3
  Text           26, 328, 456,   8, "",              .WarningText4
  Text           25, 368, 456,   8, "",              .WarningText5
  Text           26, 356, 456,   8, "",              .WarningText6
  Text           26, 382, 456,   8, "",              .WarningText7
  Text           16, 430, 256,   8, CatLang$
End Dialog

Dim Dialog2 As Dialog2Definition
On Error Resume Next
Dialog Dialog2
If Err = DIALOG_BUTTON_CANCEL Or Dialog2.Choice = 1 Then Exit Sub

' When the dialog box is running, the lookup routine that matches the language code with
' its name executes very slowly. Thus, unfortunately, it should execute outside the
' dialog box. Here's where it executes, when the "Update" button is pressed, in between
' closing and re-opening the dialog box.

If Dialog2.Choice = 2 Then
    Update = TRUE
End If

' When the "OK" button is pressed, check to see if the contents of each subfield in the
' dialog box match what was read in the existing field. Any change is a flag for
' replacement of the field. If the subfield is not empty, massage the data with the
' function "FormatSubfields" to format it for addition.

Subf1$ = LCase$( Trim$( Dialog2.TextBox1 ) )
If Subf1$ <> Trim$( Subfields( 0, aLANG_CODES_PRIMARY ) ) Then
    Change = TRUE
End If
If Subf1$ <> "" Then
    Subf1$ = FormatSubfields( Subf1$, Subfields( 0, aSUBFIELD_CODE_PRIMARY ) )
End If

Subf1K$ = LCase$( Trim$( Dialog2.TextBox1K ) )
If Subf1K$ <> Trim$( Subfields( 0, aLANG_CODES_INTERMS ) ) Then
    Change = TRUE
End If
If Subf1K$ <> "" Then
    Subf1K$ = FormatSubfields( Subf1K$, "k" )
End If

Subf1H$ = LCase$( Trim$( Dialog2.TextBox1H ) )
If Subf1H$ <> Trim$( Subfields( 0, aLANG_CODES_ORIGS ) ) Then
    Change = TRUE
End If
If Subf1H$ <> "" Then
    Subf1H$ = FormatSubfields( Subf1H$, Subfields( 0, aSUBFIELD_CODE_ORIGS ) )
End If

Subf2$ = LCase$( Trim$( Dialog2.TextBox2 ) )
If Subf2$ <> Trim$( Subfields( 1, aLANG_CODES_PRIMARY ) ) Then
    Change = TRUE
End If
If Subf2$ <> "" Then
    Subf2$ = FormatSubfields( Subf2$, Subfields( 1, aSUBFIELD_CODE_PRIMARY ) )
End If

Subf2K$ = LCase$( Trim$( Dialog2.TextBox2K ) )
If Subf2K$ <> Trim$( Subfields( 1, aLANG_CODES_INTERMS ) ) Then
    Change = TRUE
End If
If Subf2K$ <> "" Then
    Subf2K$ = FormatSubfields( Subf2K$, "k" )
End If

Subf2H$ = LCase$( Trim$( Dialog2.TextBox2H ) )
If Subf2H$ <> Trim$( Subfields( 1, aLANG_CODES_ORIGS ) ) Then
    Change = TRUE
End If
If Subf2H$ <> "" Then
    Subf2H$ = FormatSubfields( Subf2H$, Subfields( 1, aSUBFIELD_CODE_ORIGS ) )
End If

Subf3$  = LCase$( Trim$( Dialog2.TextBox3 ) )
If Subf3$ <> Trim$( Subfields( 2, aLANG_CODES_PRIMARY ) ) Then
    Change = TRUE
End If
If Subf3$ <> "" Then
    Subf3$ = FormatSubfields( Subf3$, Subfields( 2, aSUBFIELD_CODE_PRIMARY ) )
End If

Subf3K$ = LCase$( Trim$( Dialog2.TextBox3K ) )
If Subf3K$ <> Trim$( Subfields( 2, aLANG_CODES_INTERMS ) ) Then
    Change = TRUE
End If
If Subf3K$ <> "" Then
    Subf3K$ = FormatSubfields( Subf3K$, "k" )
End If

Subf3H$ = LCase$( Trim$( Dialog2.TextBox3H ) )
If Subf3H$ <> Trim$( Subfields( 2, aLANG_CODES_ORIGS ) ) Then
    Change = TRUE
End If
If Subf3H$ <> "" Then
    Subf3H$ = FormatSubfields( Subf3H$, Subfields( 2, aSUBFIELD_CODE_ORIGS ) )
End If

Subf4$  = LCase$( Trim$( Dialog2.TextBox4 ) )
If Subf4$ <> Trim$( Subfields( 3, aLANG_CODES_PRIMARY ) ) Then
    Change = TRUE
End If
If Subf4$ <> "" Then
    Subf4$ = FormatSubfields( Subf4$, Subfields( 3, aSUBFIELD_CODE_PRIMARY ) )
End If

Subf4K$ = LCase$( Trim$( Dialog2.TextBox4K ) )
If Subf4K$ <> Trim$( Subfields( 3, aLANG_CODES_INTERMS ) ) Then
    Change = TRUE
End If
If Subf4K$ <> "" Then
    Subf4K$ = FormatSubfields( Subf4K$, "k" )
End If

Subf4H$ = LCase$( Trim$( Dialog2.TextBox4H ) )
If Subf4H$ <> Trim$( Subfields( 3, aLANG_CODES_ORIGS ) ) Then
    Change = TRUE
End If
If Subf4H$ <> "" Then
    Subf4H$ = FormatSubfields( Subf4H$, Subfields( 3, aSUBFIELD_CODE_ORIGS ) )
End If

Subf5$  = LCase$( Trim$( Dialog2.TextBox5 ) )
If Subf5$ <> Trim$( Subfields( 4, aLANG_CODES_PRIMARY ) ) Then
    Change = TRUE
End If
If Subf5$ <> "" Then
    Subf5$ = FormatSubfields( Subf5$, Subfields( 4, aSUBFIELD_CODE_PRIMARY ) )
End If

Subf5K$ = LCase$( Trim$( Dialog2.TextBox5K ) )
If Subf5K$ <> Trim$( Subfields( 4, aLANG_CODES_INTERMS ) ) Then
    Change = TRUE
End If
If Subf5K$ <> "" Then
    Subf5K$ = FormatSubfields( Subf5K$, "k" )
End If

Subf5H$ = LCase$( Trim$( Dialog2.TextBox5H ) )
If Subf5H$ <> Trim$( Subfields( 4, aLANG_CODES_ORIGS ) ) Then
    Change = TRUE
End If
If Subf5H$ <> "" Then
    Subf5H$ = FormatSubfields( Subf5H$, Subfields( 4, aSUBFIELD_CODE_ORIGS ) )
End If

Subf6$  = LCase$( Trim$( Dialog2.TextBox6 ) )
If Subf6$ <> Trim$( Subfields( 5, aLANG_CODES_PRIMARY ) ) Then
    Change = TRUE
End If
If Subf6$ <> "" Then
    Subf6$ = FormatSubfields( Subf6$, Subfields( 5, aSUBFIELD_CODE_PRIMARY ) )
End If

Subf6K$ = LCase$( Trim$( Dialog2.TextBox6K ) )
If Subf6K$ <> Trim$( Subfields( 5, aLANG_CODES_INTERMS ) ) Then
    Change = TRUE
End If
If Subf6K$ <> "" Then
    Subf6K$ = FormatSubfields( Subf6K$, "k" )
End If

Subf6H$ = LCase$( Trim$( Dialog2.TextBox6H ) )
If Subf6H$ <> Trim$( Subfields( 5, aLANG_CODES_ORIGS ) ) Then
    Change = TRUE
End If
If Subf6H$ <> "" Then
    Subf6H$ = FormatSubfields( Subf6H$, Subfields( 5, aSUBFIELD_CODE_ORIGS ) )
End If

Subf7$  = LCase$( Trim$( Dialog2.TextBox7 ) )
If Subf7$ <> Trim$( Subfields( 6, aLANG_CODES_PRIMARY ) ) Then
    Change = TRUE
End If
If Subf7$ <> "" Then
    Subf7$ = FormatSubfields( Subf7$, Subfields( 6, aSUBFIELD_CODE_PRIMARY ) )
End If

Subf7K$ = LCase$( Trim$( Dialog2.TextBox7K ) )
If Subf7K$ <> Trim$( Subfields( 6, aLANG_CODES_INTERMS ) ) Then
    Change = TRUE
End If
If Subf7K$ <> "" Then
    Subf7K$ = FormatSubfields( Subf7K$, "k" )
End If

Subf7H$ = LCase$( Trim$( Dialog2.TextBox7H ) )
If Subf7H$ <> Trim$( Subfields( 6, aLANG_CODES_ORIGS ) ) Then
    Change = TRUE
End If
If Subf7H$ <> "" Then
    Subf7H$ = FormatSubfields( Subf7H$, Subfields( 6, aSUBFIELD_CODE_ORIGS ) )
End If

If Update = TRUE Then
    Update = FALSE
    GoTo Recycle:
End If

' Construct the field for addition or replacement. Add the contents of all the text boxes
' and make the whole string lowercase.

If Change = TRUE Or AddNew = TRUE Then
    NewField$     =             Subf1$ & " " & Subf1K$ & " " & Subf1H$ & " " & Subf2$ & " " & Subf2K$ & " " & Subf2H$ & " "
    NewField$     = NewField$ & Subf3$ & " " & Subf3K$ & " " & Subf3H$ & " " & Subf4$ & " " & Subf4K$ & " " & Subf4H$ & " "
    NewField$     = NewField$ & Subf5$ & " " & Subf5K$ & " " & Subf5H$ & " " & Subf6$ & " " & Subf6K$ & " " & Subf6H$ & " "
    NewField$     = NewField$ & Subf7$ & " " & Subf7K$ & " " & Subf7H$
    NewField$     = LCase$( NewField$ )
    AllSubfields$ =                 GetSubfieldCode( Subf1$ ) & GetSubfieldCode( Subf1K$ ) & GetSubfieldCode( Subf1H$ )
    AllSubfields$ = AllSubfields$ & GetSubfieldCode( Subf2$ ) & GetSubfieldCode( Subf2K$ ) & GetSubfieldCode( Subf2H$ )
    AllSubfields$ = AllSubfields$ & GetSubfieldCode( Subf3$ ) & GetSubfieldCode( Subf3K$ ) & GetSubfieldCode( Subf3H$ )
    AllSubfields$ = AllSubfields$ & GetSubfieldCode( Subf4$ ) & GetSubfieldCode( Subf4K$ ) & GetSubfieldCode( Subf4H$ )
    AllSubfields$ = AllSubfields$ & GetSubfieldCode( Subf5$ ) & GetSubfieldCode( Subf5K$ ) & GetSubfieldCode( Subf5H$ )
    AllSubfields$ = AllSubfields$ & GetSubfieldCode( Subf6$ ) & GetSubfieldCode( Subf6K$ ) & GetSubfieldCode( Subf6H$ )
    AllSubfields$ = AllSubfields$ & GetSubfieldCode( Subf7$ ) & GetSubfieldCode( Subf7K$ ) & GetSubfieldCode( Subf7H$ )

' No data entered: If there is an existing 041, see if the field is intended to be
' deleted, and if so, zap it (although this is not the most efficient way of deleting a
' field!). If a field was to be added but no data was supplied, do nothing.

    If Trim$( NewField$ ) = "" Then
        If Found041 Then
            Answer% = MsgBox( "Do you really want to delete the 041 field?", 36, WaltsMacros$ )
            If Answer% = 7 Then
                Exit Sub
              Else
                If CS.DeleteField( "041", 1 ) Then
                    MsgBox "Field 041 deleted!", INFORMATION_MESSAGE, WaltsMacros$
                  Else
                    MsgBox "Sorry, could not delete the 041 field.", CRITICAL_MESSAGE, WaltsMacros$
                End If
                Exit Sub
            End If
          Else
            MsgBox "041 field not added!", CRITICAL_MESSAGE, WaltsMacros$
            Exit Sub
        End If
    End If

' Subfields $h, $k, $m, or $n present, and item is not a sound recording: Set the first
' indicator to "1" to indicate a translation, but display a warning to verify this. For
' sound recordings, a translation applies only to text, which will almost always be
' accompanying material. Accompanying material is not considered when determining if an
' item is a translation.

    If ( InStr( AllSubfields$, "h" ) <> 0 Or InStr( AllSubfields$, "k" ) <> 0 Or InStr( AllSubfields$, "m" ) <> 0 Or InStr( AllSubfields$, "n" ) <> 0 ) _
       And FF_Type$ Like "[!ij]" Then
        Ind1$ = "1"
      Else
        Ind1$ = "0"
    End If

' Complete the field by adding tag and indicators.

    NewField$ = Tag$ & Ind1$ & Ind2$ & Trim$( NewField$ )

' Get rid of any extra spaces.

    Do
      p = InStr( NewField$, "  " )
      If p <> 0 Then
          NewField$ = Left$( NewField$, p ) & Mid$( NewField$, p + 2 )
      End If
    Loop Until p = 0

' Check that the first code in the field matches the code in the fixed field. If it does
' not, display a warning, and ask about continuing. Exit the macro if this is considered
' a major problem.

    If FF_Lang$ <> "999" Then
        FirstLangCode$ = Mid$( NewField$, 9, LANG_CODE_LENGTH )
        If FF_Lang$ <> FirstLangCode$ Then
            If FF_Lang$ <> "zxx" And FF_Type$ <> "j" Then

                Begin Dialog Dialog3Definition 208, 100, WaltsMacros$, .Dialog1ControlFunction
                  ButtonGroup .Choice
                   PushButton   28, 68,  64, 16, "&Yes, continue"
                   PushButton  112, 68,  64, 16, "&No, exit macro"
                   CancelButton  1, 1, 1, 1
                  Text          12,  8, 184, 16, "The first language code in the 041 does not match the language code in the fixed field! Continue adding field?"
                  Text          40, 34,  94,  8, "First code in 041:"
                  Text         136, 34,  16,  8, FirstLangCode$
                  Text          40, 44,  94,  8, "Language code in fixed field:"
                  Text         136, 44,  16,  8, FF_Lang$
                End Dialog

                Dim Dialog3 as Dialog3Definition
                On Error Resume Next
                Dialog Dialog3
                If Err = DIALOG_BUTTON_CANCEL Or Dialog3.Choice > 0 Then
                    Exit Sub
                End If

            End If
        End If
    End If

' If the first subfield is $a, delete the delimiter and subfield code.

    If Mid$( NewField$, 6, 2 ) = DELIMITER & "a" Then
        Newfield$ = Left$( NewField$, 5 ) & Mid$( NewField$, 9 )
    End If

' Add a new field.

    If AddNew = TRUE Then
        If CS.AddField( 1, NewField$ ) Then
            If Ind1$ = "1" And AddNew = TRUE Then
                MsgBox "041 field added. Verify the value of the first indicator: Is the item really a translation?", WARNING_MESSAGE, WaltsMacros$
              Else
                MsgBox "041 field added!", INFORMATION_MESSAGE, WaltsMacros$
            End If
          Else
            MsgBox "Sorry, could not add new 041 field.", CRITICAL_MESSAGE, WaltsMacros$
        End If

' Replace an existing field.

      Else
        If In041 Then
            If CS.SetFieldLine( Row%, NewField$ ) Then
                MsgBox "041 field replaced!", INFORMATION_MESSAGE, WaltsMacros$
              Else
                MsgBox "Sorry, could not replace 041 field.", CRITICAL_MESSAGE, WaltsMacros$
            End If
          Else
            If CS.SetField( 1, NewField$ ) Then
                MsgBox "041 field replaced!", INFORMATION_MESSAGE, WaltsMacros$
              Else
                MsgBox "Sorry, could not replace 041 field.", CRITICAL_MESSAGE, WaltsMacros$
            End If
        End If
    End If

' Even if nothing was changed, display a warning if the first code in the field does not
' match that in the fixed field.

  Else
    If FF_Lang$ <> "999" Then
        If FF_Lang$ <> Mid$( Subf1$, 4, LANG_CODE_LENGTH ) Then
            If Mid$( Subf1$, 2, 1 ) = "d" Then
                MsgBox "No change made to 041 field--but the first language code in the 041 does not match the language code in the fixed field!", WARNING_MESSAGE, WaltsMacros$
              Else
                MsgBox "No change made to 041 field!", INFORMATION_MESSAGE, WaltsMacros$
            End If
          Else
            If ChangeFF = FALSE Then
                MsgBox "No change made to 041 field!", INFORMATION_MESSAGE, WaltsMacros$
              Else
                MsgBox "No change made to 041 field--but the language code in the fixed field was changed!", INFORMATION_MESSAGE, WaltsMacros$
            End If
        End If
    End If
End If

End Sub
'****************************************************************************************
Sub AddLanguageCodeToBox( Selection%, SelectedCode$, SourceOfAddition% )

' Additions to text boxes can be made by typing or by selecting a language from the drop-
' down list. If the addition is from the list, it will be a single three-letter code; if
' from typing, any number of codes may be added. This sub takes the addition and adds it
' to the array for processing (that is, for showing the language names when the "Update
' form" button is clicked, or when the whole field is added to the record). The
' "SourceOfAddition%" variable tells whether the addition is a simple code selected from
' the drop-down list of languages ("FROM_LANG_LIST", or 1) or not (any other value).

Dim z As Integer

Select Case Selection%

  Case ID_FIRST_TEXT_BOX
    If SourceOfAddition% = FROM_LANG_LIST Then
        Subf1$        = Trim$( DlgText( "TextBox1" ) & " " & SelectedCode$ )
      Else
        Subf1$        = Trim$( DlgText( "TextBox1" ) )
    End If
    DlgText         "TextBox1",         Subf1$
    z                 = UBound( CodesNames1 )
    If CodesNames1( 0 ) <> "" Then z = z + 1
    ReDim Preserve CodesNames1( z )
    CodesNames1( z )  = SelectedCode$ & " = [Update form to see name]"
    DlgListBoxArray "SubfieldContents", CodesNames1()

  Case ID_FIRST_TEXT_BOX + 1
    If SourceOfAddition% = FROM_LANG_LIST Then
        Subf1K$        = Trim$( DlgText( "TextBox1K" ) & " " & SelectedCode$ )
      Else
        Subf1K$        = Trim$( DlgText( "TextBox1K" ) )
    End If
    DlgText         "TextBox1K",        Subf1K$
    z                 = UBound( CodesNames1K )
    If CodesNames1K( 0 ) <> "" Then z = z + 1
    ReDim Preserve CodesNames1K( z )
    CodesNames1K( z ) = SelectedCode$ & " = [Update form to see name]"
    DlgListBoxArray "SubfieldContents", CodesNames1K()

  Case ID_FIRST_TEXT_BOX + 2
    If SourceOfAddition% = FROM_LANG_LIST Then
        Subf1H$        = Trim$( DlgText( "TextBox1H" ) & " " & SelectedCode$ )
      Else
        Subf1H$        = Trim$( DlgText( "TextBox1H" ) )
    End If
    DlgText         "TextBox1H",        Subf1H$
    z                 = UBound( CodesNames1H )
    If CodesNames1H( 0 ) <> "" Then z = z + 1
    ReDim Preserve CodesNames1H( z )
    CodesNames1H( z ) = SelectedCode$ & " = [Update form to see name]"
    DlgListBoxArray "SubfieldContents", CodesNames1H()

  Case ID_FIRST_TEXT_BOX + 3
    If SourceOfAddition% = FROM_LANG_LIST Then
        Subf2$        = Trim$( DlgText( "TextBox2" ) & " " & SelectedCode$ )
      Else
        Subf2$        = Trim$( DlgText( "TextBox2" ) )
    End If
    DlgText         "TextBox2",         Subf2$
    z                 = UBound( CodesNames2 )
    If CodesNames2( 0 ) <> "" Then z = z + 1
    ReDim Preserve CodesNames2( z )
    CodesNames2( z )  = SelectedCode$ & " = [Update form to see name]"
    DlgListBoxArray "SubfieldContents", CodesNames2()

  Case ID_FIRST_TEXT_BOX + 4
    If SourceOfAddition% = FROM_LANG_LIST Then
        Subf2K$        = Trim$( DlgText( "TextBox2K" ) & " " & SelectedCode$ )
      Else
        Subf2K$        = Trim$( DlgText( "TextBox2K" ) )
    End If
    DlgText         "TextBox2K",        Subf2K$
    z                 = UBound( CodesNames2K )
    If CodesNames2K( 0 ) <> "" Then z = z + 1
    ReDim Preserve CodesNames2K( z )
    CodesNames2K( z ) = SelectedCode$ & " = [Update form to see name]"
    DlgListBoxArray "SubfieldContents", CodesNames2K()

  Case ID_FIRST_TEXT_BOX + 5
    If SourceOfAddition% = FROM_LANG_LIST Then
        Subf2H$        = Trim$( DlgText( "TextBox2H" ) & " " & SelectedCode$ )
      Else
        Subf2H$        = Trim$( DlgText( "TextBox2H" ) )
    End If
    DlgText         "TextBox2H",        Subf2H$
    z                 = UBound( CodesNames2H )
    If CodesNames2H( 0 ) <> "" Then z = z + 1
    ReDim Preserve CodesNames2H( z )
    CodesNames2H( z ) = SelectedCode$ & " = [Update form to see name]"
    DlgListBoxArray "SubfieldContents", CodesNames2H()

  Case ID_FIRST_TEXT_BOX + 6
    If SourceOfAddition% = FROM_LANG_LIST Then
        Subf3$        = Trim$( DlgText( "TextBox3" ) & " " & SelectedCode$ )
      Else
        Subf3$        = Trim$( DlgText( "TextBox3" ) )
    End If
    DlgText         "TextBox3",         Subf3$
    z                 = UBound( CodesNames3 )
    If CodesNames3( 0 ) <> "" Then z = z + 1
    ReDim Preserve CodesNames3( z )
    CodesNames3( z )  = SelectedCode$ & " = [Update form to see name]"
    DlgListBoxArray "SubfieldContents", CodesNames3()

  Case ID_FIRST_TEXT_BOX + 7
    If SourceOfAddition% = FROM_LANG_LIST Then
        Subf3K$        = Trim$( DlgText( "TextBox3K" ) & " " & SelectedCode$ )
      Else
        Subf3K$        = Trim$( DlgText( "TextBox3K" ) )
    End If
    DlgText         "TextBox3K",        Subf3K$
    z                 = UBound( CodesNames3K )
    If CodesNames3K( 0 ) <> "" Then z = z + 1
    ReDim Preserve CodesNames3K( z )
    CodesNames3K( z ) = SelectedCode$ & " = [Update form to see name]"
    DlgListBoxArray "SubfieldContents", CodesNames3K()

  Case ID_FIRST_TEXT_BOX + 8
    If SourceOfAddition% = FROM_LANG_LIST Then
        Subf3H$        = Trim$( DlgText( "TextBox3H" ) & " " & SelectedCode$ )
      Else
        Subf3H$        = Trim$( DlgText( "TextBox3H" ) )
    End If
    DlgText         "TextBox3H",        Subf3H$
    z                 = UBound( CodesNames3H )
    If CodesNames3H( 0 ) <> "" Then z = z + 1
    ReDim Preserve CodesNames3H( z )
    CodesNames3H( z ) = SelectedCode$ & " = [Update form to see name]"
    DlgListBoxArray "SubfieldContents", CodesNames3H()

  Case ID_FIRST_TEXT_BOX + 9
    If SourceOfAddition% = FROM_LANG_LIST Then
        Subf4$        = Trim$( DlgText( "TextBox4" ) & " " & SelectedCode$ )
      Else
        Subf4$        = Trim$( DlgText( "TextBox4" ) )
    End If
    DlgText         "TextBox4",         Subf4$
    z                 = UBound( CodesNames4 )
    If CodesNames4( 0 ) <> "" Then z = z + 1
    ReDim Preserve CodesNames4( z )
    CodesNames4( z )  = SelectedCode$ & " = [Update form to see name]"
    DlgListBoxArray "SubfieldContents", CodesNames4()

  Case ID_FIRST_TEXT_BOX + 10
    If SourceOfAddition% = FROM_LANG_LIST Then
        Subf4K$        = Trim$( DlgText( "TextBox4K" ) & " " & SelectedCode$ )
      Else
        Subf4K$        = Trim$( DlgText( "TextBox4K" ) )
    End If
    DlgText         "TextBox4K",        Subf4K$
    z                 = UBound( CodesNames4K )
    If CodesNames4K( 0 ) <> "" Then z = z + 1
    ReDim Preserve CodesNames4K( z )
    CodesNames4K( z ) = SelectedCode$ & " = [Update form to see name]"
    DlgListBoxArray "SubfieldContents", CodesNames4K()

  Case ID_FIRST_TEXT_BOX + 11
    If SourceOfAddition% = FROM_LANG_LIST Then
        Subf4H$        = Trim$( DlgText( "TextBox4H" ) & " " & SelectedCode$ )
      Else
        Subf4H$        = Trim$( DlgText( "TextBox4H" ) )
    End If
    DlgText         "TextBox4H",        Subf4H$
    z                 = UBound( CodesNames4H )
    If CodesNames4H( 0 ) <> "" Then z = z + 1
    ReDim Preserve CodesNames4H( z )
    CodesNames4H( z ) = SelectedCode$ & " = [Update form to see name]"
    DlgListBoxArray "SubfieldContents", CodesNames4H()

  Case ID_FIRST_TEXT_BOX + 12
    If SourceOfAddition% = FROM_LANG_LIST Then
        Subf5$        = Trim$( DlgText( "TextBox5" ) & " " & SelectedCode$ )
      Else
        Subf5$        = Trim$( DlgText( "TextBox5" ) )
    End If
    DlgText         "TextBox5",         Subf5$
    z                 = UBound( CodesNames5 )
    If CodesNames5( 0 ) <> "" Then z = z + 1
    ReDim Preserve CodesNames5( z )
    CodesNames5( z )  = SelectedCode$ & " = [Update form to see name]"
    DlgListBoxArray "SubfieldContents", CodesNames5()

  Case ID_FIRST_TEXT_BOX + 13
    If SourceOfAddition% = FROM_LANG_LIST Then
        Subf5K$        = Trim$( DlgText( "TextBox5K" ) & " " & SelectedCode$ )
      Else
        Subf5K$        = Trim$( DlgText( "TextBox5K" ) )
    End If
    DlgText         "TextBox5K",        Subf5K$
    z                 = UBound( CodesNames5K )
    If CodesNames5K( 0 ) <> "" Then z = z + 1
    ReDim Preserve CodesNames5K( z )
    CodesNames5K( z ) = SelectedCode$ & " = [Update form to see name]"
    DlgListBoxArray "SubfieldContents", CodesNames5K()

  Case ID_FIRST_TEXT_BOX + 14
    If SourceOfAddition% = FROM_LANG_LIST Then
        Subf5H$        = Trim$( DlgText( "TextBox5H" ) & " " & SelectedCode$ )
      Else
        Subf5H$        = Trim$( DlgText( "TextBox5H" ) )
    End If
    DlgText         "TextBox5H",        Subf5H$
    z                 = UBound( CodesNames5H )
    If CodesNames5H( 0 ) <> "" Then z = z + 1
    ReDim Preserve CodesNames5H( z )
    CodesNames5H( z ) = SelectedCode$ & " = [Update form to see name]"
    DlgListBoxArray "SubfieldContents", CodesNames5H()

  Case ID_FIRST_TEXT_BOX + 15
    If SourceOfAddition% = FROM_LANG_LIST Then
        Subf6$        = Trim$( DlgText( "TextBox6" ) & " " & SelectedCode$ )
      Else
        Subf6$        = Trim$( DlgText( "TextBox6" ) )
    End If
    DlgText         "TextBox6",         Subf6$
    z                 = UBound( CodesNames6 )
    If CodesNames6( 0 ) <> "" Then z = z + 1
    ReDim Preserve CodesNames6( z )
    CodesNames6( z )  = SelectedCode$ & " = [Update form to see name]"
    DlgListBoxArray "SubfieldContents", CodesNames6()

  Case ID_FIRST_TEXT_BOX + 16
    If SourceOfAddition% = FROM_LANG_LIST Then
        Subf6K$        = Trim$( DlgText( "TextBox6K" ) & " " & SelectedCode$ )
      Else
        Subf6K$        = Trim$( DlgText( "TextBox6K" ) )
    End If
    DlgText         "TextBox6K",        Subf6K$
    z                 = UBound( CodesNames6K )
    If CodesNames6K( 0 ) <> "" Then z = z + 1
    ReDim Preserve CodesNames6K( z )
    CodesNames6K( z ) = SelectedCode$ & " = [Update form to see name]"
    DlgListBoxArray "SubfieldContents", CodesNames6K()

  Case ID_FIRST_TEXT_BOX + 17
    If SourceOfAddition% = FROM_LANG_LIST Then
        Subf6H$        = Trim$( DlgText( "TextBox6H" ) & " " & SelectedCode$ )
      Else
        Subf6H$        = Trim$( DlgText( "TextBox6H" ) )
    End If
    DlgText         "TextBox6H",        Subf6H$
    z                 = UBound( CodesNames6H )
    If CodesNames6H( 0 ) <> "" Then z = z + 1
    ReDim Preserve CodesNames6H( z )
    CodesNames6H( z ) = SelectedCode$ & " = [Update form to see name]"
    DlgListBoxArray "SubfieldContents", CodesNames6H()

  Case ID_FIRST_TEXT_BOX + 18
    If SourceOfAddition% = FROM_LANG_LIST Then
        Subf7$        = Trim$( DlgText( "TextBox7" ) & " " & SelectedCode$ )
      Else
        Subf7$        = Trim$( DlgText( "TextBox7" ) )
    End If
    DlgText         "TextBox7",         Subf7$
    z                 = UBound( CodesNames7 )
    If CodesNames7( 0 ) <> "" Then z = z + 1
    ReDim Preserve CodesNames7( z )
    CodesNames7( z )  = SelectedCode$ & " = [Update form to see name]"
    DlgListBoxArray "SubfieldContents", CodesNames7()

  Case ID_FIRST_TEXT_BOX + 19
    If SourceOfAddition% = FROM_LANG_LIST Then
        Subf7K$        = Trim$( DlgText( "TextBox7H" ) & " " & SelectedCode$ )
      Else
        Subf7K$        = Trim$( DlgText( "TextBox7H" ) )
    End If
    DlgText         "TextBox7K",        Subf7K$
    z                 = UBound( CodesNames7K )
    If CodesNames7K( 0 ) <> "" Then z = z + 1
    ReDim Preserve CodesNames7K( z )
    CodesNames7K( z ) = SelectedCode$ & " = [Update form to see name]"
    DlgListBoxArray "SubfieldContents", CodesNames7K()

  Case ID_FIRST_TEXT_BOX + 20
    If SourceOfAddition% = FROM_LANG_LIST Then
        Subf7H$        = Trim$( DlgText( "TextBox7H" ) & " " & SelectedCode$ )
      Else
        Subf7H$        = Trim$( DlgText( "TextBox7H" ) )
    End If
    DlgText         "TextBox7H",        Subf7H$
    z                 = UBound( CodesNames7H )
    If CodesNames7H( 0 ) <> "" Then z = z + 1
    ReDim Preserve CodesNames7H( z )
    CodesNames7H( z ) = SelectedCode$ & " = [Update form to see name]"
    DlgListBoxArray "SubfieldContents", CodesNames7H()

End Select

End Sub
'****************************************************************************************
Sub CompareBoxes( WhichBox%, SubmittedText$ )

' If the text in a dialog box has changed, this routine extracts that change so the array
' for that particular subfield can be added to.

Dim AddedText$

Dim p As Integer

Select Case WhichBox%

  Case ID_FIRST_TEXT_BOX
    p = InStr( SubmittedText$, Subf1$ )
    If p = 1 Then
        p = Len( Subf1$ )
        AddedText$ = Trim$( Mid$( SubmittedText$, p + 1 ) )
      ElseIf p > 1 Then
        AddedText$ = Trim$( Left$( SubmittedText$, p - 1 ) )
    End If

  Case ID_FIRST_TEXT_BOX + 1
    p = InStr( SubmittedText$, Subf1K$ )
    If p = 1 Then
        p = Len( Subf1K$ )
        AddedText$ = Trim$( Mid$( SubmittedText$, p + 1 ) )
      ElseIf p > 1 Then
        AddedText$ = Trim$( Left$( SubmittedText$, p - 1 ) )
    End If

  Case ID_FIRST_TEXT_BOX + 2
    p = InStr( SubmittedText$, Subf1H$ )
    If p = 1 Then
        p = Len( Subf1H$ )
        AddedText$ = Trim$( Mid$( SubmittedText$, p + 1 ) )
      ElseIf p > 1 Then
        AddedText$ = Trim$( Left$( SubmittedText$, p - 1 ) )
    End If

  Case ID_FIRST_TEXT_BOX + 3
    p = InStr( SubmittedText$, Subf2$ )
    If p = 1 Then
        p = Len( Subf2$ )
        AddedText$ = Trim$( Mid$( SubmittedText$, p + 1 ) )
      ElseIf p > 1 Then
        AddedText$ = Trim$( Left$( SubmittedText$, p - 1 ) )
    End If

  Case ID_FIRST_TEXT_BOX + 4
    p = InStr( SubmittedText$, Subf2K$ )
    If p = 1 Then
        p = Len( Subf2K$ )
        AddedText$ = Trim$( Mid$( SubmittedText$, p + 1 ) )
      ElseIf p > 1 Then
        AddedText$ = Trim$( Left$( SubmittedText$, p - 1 ) )
    End If

  Case ID_FIRST_TEXT_BOX + 5
    p = InStr( SubmittedText$, Subf2H$ )
    If p = 1 Then
        p = Len( Subf2H$ )
        AddedText$ = Trim$( Mid$( SubmittedText$, p + 1 ) )
      ElseIf p > 1 Then
        AddedText$ = Trim$( Left$( SubmittedText$, p - 1 ) )
    End If

  Case ID_FIRST_TEXT_BOX + 6
    p = InStr( SubmittedText$, Subf3$ )
    If p = 1 Then
        p = Len( Subf3$ )
        AddedText$ = Trim$( Mid$( SubmittedText$, p + 1 ) )
      ElseIf p > 1 Then
        AddedText$ = Trim$( Left$( SubmittedText$, p - 1 ) )
    End If

  Case ID_FIRST_TEXT_BOX + 7
    p = InStr( SubmittedText$, Subf3K$ )
    If p = 1 Then
        p = Len( Subf3K$ )
        AddedText$ = Trim$( Mid$( SubmittedText$, p + 1 ) )
      ElseIf p > 1 Then
        AddedText$ = Trim$( Left$( SubmittedText$, p - 1 ) )
    End If

  Case ID_FIRST_TEXT_BOX + 8
    p = InStr( SubmittedText$, Subf3H$ )
    If p = 1 Then
        p = Len( Subf3H$ )
        AddedText$ = Trim$( Mid$( SubmittedText$, p + 1 ) )
      ElseIf p > 1 Then
        AddedText$ = Trim$( Left$( SubmittedText$, p - 1 ) )
    End If

  Case ID_FIRST_TEXT_BOX + 9
    p = InStr( SubmittedText$, Subf4$ )
    If p = 1 Then
        p = Len( Subf4$ )
        AddedText$ = Trim$( Mid$( SubmittedText$, p + 1 ) )
      ElseIf p > 1 Then
        AddedText$ = Trim$( Left$( SubmittedText$, p - 1 ) )
    End If

  Case ID_FIRST_TEXT_BOX + 10
    p = InStr( SubmittedText$, Subf4K$ )
    If p = 1 Then
        p = Len( Subf4K$ )
        AddedText$ = Trim$( Mid$( SubmittedText$, p + 1 ) )
      ElseIf p > 1 Then
        AddedText$ = Trim$( Left$( SubmittedText$, p - 1 ) )
    End If

  Case ID_FIRST_TEXT_BOX + 11
    p = InStr( SubmittedText$, Subf4H$ )
    If p = 1 Then
        p = Len( Subf4H$ )
        AddedText$ = Trim$( Mid$( SubmittedText$, p + 1 ) )
      ElseIf p > 1 Then
        AddedText$ = Trim$( Left$( SubmittedText$, p - 1 ) )
    End If

  Case ID_FIRST_TEXT_BOX + 12
    p = InStr( SubmittedText$, Subf5$ )
    If p = 1 Then
        p = Len( Subf5$ )
        AddedText$ = Trim$( Mid$( SubmittedText$, p + 1 ) )
      ElseIf p > 1 Then
        AddedText$ = Trim$( Left$( SubmittedText$, p - 1 ) )
    End If

  Case ID_FIRST_TEXT_BOX + 13
    p = InStr( SubmittedText$, Subf5K$ )
    If p = 1 Then
        p = Len( Subf5K$ )
        AddedText$ = Trim$( Mid$( SubmittedText$, p + 1 ) )
      ElseIf p > 1 Then
        AddedText$ = Trim$( Left$( SubmittedText$, p - 1 ) )
    End If

  Case ID_FIRST_TEXT_BOX + 14
    p = InStr( SubmittedText$, Subf5H$ )
    If p = 1 Then
        p = Len( Subf5H$ )
        AddedText$ = Trim$( Mid$( SubmittedText$, p + 1 ) )
      ElseIf p > 1 Then
        AddedText$ = Trim$( Left$( SubmittedText$, p - 1 ) )
    End If

  Case ID_FIRST_TEXT_BOX + 15
    p = InStr( SubmittedText$, Subf6$ )
    If p = 1 Then
        p = Len( Subf6$ )
        AddedText$ = Trim$( Mid$( SubmittedText$, p + 1 ) )
      ElseIf p > 1 Then
        AddedText$ = Trim$( Left$( SubmittedText$, p - 1 ) )
    End If

  Case ID_FIRST_TEXT_BOX + 16
    p = InStr( SubmittedText$, Subf6K$ )
    If p = 1 Then
        p = Len( Subf6K$ )
        AddedText$ = Trim$( Mid$( SubmittedText$, p + 1 ) )
      ElseIf p > 1 Then
        AddedText$ = Trim$( Left$( SubmittedText$, p - 1 ) )
    End If

  Case ID_FIRST_TEXT_BOX + 17
    p = InStr( SubmittedText$, Subf6H$ )
    If p = 1 Then
        p = Len( Subf6H$ )
        AddedText$ = Trim$( Mid$( SubmittedText$, p + 1 ) )
      ElseIf p > 1 Then
        AddedText$ = Trim$( Left$( SubmittedText$, p - 1 ) )
    End If

  Case ID_FIRST_TEXT_BOX + 418
    p = InStr( SubmittedText$, Subf7$ )
    If p = 1 Then
        p = Len( Subf7$ )
        AddedText$ = Trim$( Mid$( SubmittedText$, p + 1 ) )
      ElseIf p > 1 Then
        AddedText$ = Trim$( Left$( SubmittedText$, p - 1 ) )
    End If

  Case ID_FIRST_TEXT_BOX + 19
    p = InStr( SubmittedText$, Subf7K$ )
    If p = 1 Then
        p = Len( Subf7K$ )
        AddedText$ = Trim$( Mid$( SubmittedText$, p + 1 ) )
      ElseIf p > 1 Then
        AddedText$ = Trim$( Left$( SubmittedText$, p - 1 ) )
    End If

  Case ID_FIRST_TEXT_BOX + 20
    p = InStr( SubmittedText$, Subf7H$ )
    If p = 1 Then
        p = Len( Subf7H$ )
        AddedText$ = Trim$( Mid$( SubmittedText$, p + 1 ) )
      ElseIf p > 1 Then
        AddedText$ = Trim$( Left$( SubmittedText$, p - 1 ) )
    End If

End Select

' When the added information is isolated, add it to the array

Call AddLanguageCodeToBox( WhichBox%, AddedText$, FROM_LANG_LIST - 1 )

End Sub
'****************************************************************************************
Sub InitializeDialog2Definition

' This routine initializes the main dialog box, filling the text boxes with beginning
' values and setting visibility and enabling of appropriate controls.

' Initialize the dialog box with the contents of the field as read, from the array
' "Subfields" and the derived arrays for the individual text boxes.

DlgText         "LabelCode1",       Subfields( 0, aSUBFIELD_CODE_PRIMARY )
DlgText         "LabelCode2",       Subfields( 1, aSUBFIELD_CODE_PRIMARY )
DlgText         "LabelCode3",       Subfields( 2, aSUBFIELD_CODE_PRIMARY )
DlgText         "LabelCode4",       Subfields( 3, aSUBFIELD_CODE_PRIMARY )
DlgText         "LabelCode5",       Subfields( 4, aSUBFIELD_CODE_PRIMARY )
DlgText         "LabelCode6",       Subfields( 5, aSUBFIELD_CODE_PRIMARY )
DlgText         "LabelCode7",       Subfields( 6, aSUBFIELD_CODE_PRIMARY )
DlgText         "LabelDefn1",       Subfields( 0, aSUBFIELD_DEFN )
DlgText         "LabelDefn2",       Subfields( 1, aSUBFIELD_DEFN )
DlgText         "LabelDefn3",       Subfields( 2, aSUBFIELD_DEFN )
DlgText         "LabelDefn4",       Subfields( 3, aSUBFIELD_DEFN )
DlgText         "LabelDefn5",       Subfields( 4, aSUBFIELD_DEFN )
DlgText         "LabelDefn6",       Subfields( 5, aSUBFIELD_DEFN )
DlgText         "LabelDefn7",       Subfields( 6, aSUBFIELD_DEFN )
DlgText         "TextBox1",         Subf1$
DlgText         "TextBox2",         Subf2$
DlgText         "TextBox3",         Subf3$
DlgText         "TextBox4",         Subf4$
DlgText         "TextBox5",         Subf5$
DlgText         "TextBox6",         Subf6$
DlgText         "TextBox7",         Subf7$
DlgText         "TextBox1H",        Subf1H$
DlgText         "TextBox2H",        Subf2H$
DlgText         "TextBox3H",        Subf3H$
DlgText         "TextBox4H",        Subf4H$
DlgText         "TextBox5H",        Subf5H$
DlgText         "TextBox6H",        Subf6H$
DlgText         "TextBox7H",        Subf7H$
DlgText         "TextBox1K",        Subf1K$
DlgText         "TextBox2K",        Subf2K$
DlgText         "TextBox3K",        Subf3K$
DlgText         "TextBox4K",        Subf4K$
DlgText         "TextBox5K",        Subf5K$
DlgText         "TextBox6K",        Subf6K$
DlgText         "TextBox7K",        Subf7K$
DlgText         "OrigLang1",        Subfields( 0, aSUBFIELD_CODE_ORIGS )
DlgText         "OrigLang2",        Subfields( 1, aSUBFIELD_CODE_ORIGS )
DlgText         "OrigLang3",        Subfields( 2, aSUBFIELD_CODE_ORIGS )
DlgText         "OrigLang4",        Subfields( 3, aSUBFIELD_CODE_ORIGS )
DlgText         "OrigLang5",        Subfields( 4, aSUBFIELD_CODE_ORIGS )
DlgText         "OrigLang6",        Subfields( 5, aSUBFIELD_CODE_ORIGS )
DlgText         "OrigLang7",        Subfields( 6, aSUBFIELD_CODE_ORIGS )

DlgVisible      "WarningButton1",   INVISIBLE
DlgVisible      "WarningButton2",   INVISIBLE
DlgVisible      "WarningText1",     INVISIBLE
DlgVisible      "WarningText2",     INVISIBLE
DlgVisible      "WarningText3",     INVISIBLE
DlgVisible      "WarningText4",     INVISIBLE
DlgVisible      "WarningText5",     INVISIBLE
DlgVisible      "WarningText6",     INVISIBLE
DlgVisible      "WarningText7",     INVISIBLE

DlgVisible      "Cancel",           INVISIBLE
DlgText         "LangFF",           FFLangDisplay$
DlgFocus        InitialFocus%

Select Case InitialFocus%
  Case ID_FIRST_TEXT_BOX
    DlgListBoxArray "SubfieldContents", CodesNames1()
  Case ID_FIRST_TEXT_BOX + 1
    DlgListBoxArray "SubfieldContents", CodesNames1K()
  Case ID_FIRST_TEXT_BOX + 2
    DlgListBoxArray "SubfieldContents", CodesNames1H()
  Case ID_FIRST_TEXT_BOX + 3
    DlgListBoxArray "SubfieldContents", CodesNames2()
  Case ID_FIRST_TEXT_BOX + 4
    DlgListBoxArray "SubfieldContents", CodesNames2K()
  Case ID_FIRST_TEXT_BOX + 5
    DlgListBoxArray "SubfieldContents", CodesNames2H()
  Case ID_FIRST_TEXT_BOX + 6
    DlgListBoxArray "SubfieldContents", CodesNames3()
  Case ID_FIRST_TEXT_BOX + 7
    DlgListBoxArray "SubfieldContents", CodesNames3K()
  Case ID_FIRST_TEXT_BOX + 8
    DlgListBoxArray "SubfieldContents", CodesNames3H()
  Case ID_FIRST_TEXT_BOX + 9
    DlgListBoxArray "SubfieldContents", CodesNames4()
  Case ID_FIRST_TEXT_BOX + 10
    DlgListBoxArray "SubfieldContents", CodesNames4K()
  Case ID_FIRST_TEXT_BOX + 11
    DlgListBoxArray "SubfieldContents", CodesNames4H()
  Case ID_FIRST_TEXT_BOX + 12
    DlgListBoxArray "SubfieldContents", CodesNames5()
  Case ID_FIRST_TEXT_BOX + 13
    DlgListBoxArray "SubfieldContents", CodesNames5K()
  Case ID_FIRST_TEXT_BOX + 14
    DlgListBoxArray "SubfieldContents", CodesNames5H()
  Case ID_FIRST_TEXT_BOX + 15
    DlgListBoxArray "SubfieldContents", CodesNames6()
  Case ID_FIRST_TEXT_BOX + 16
    DlgListBoxArray "SubfieldContents", CodesNames6K()
  Case ID_FIRST_TEXT_BOX + 17
    DlgListBoxArray "SubfieldContents", CodesNames6H()
  Case ID_FIRST_TEXT_BOX + 18
    DlgListBoxArray "SubfieldContents", CodesNames7()
  Case ID_FIRST_TEXT_BOX + 19
    DlgListBoxArray "SubfieldContents", CodesNames7K()
  Case ID_FIRST_TEXT_BOX + 20
    DlgListBoxArray "SubfieldContents", CodesNames7H()
End Select

End Sub
'****************************************************************************************
Sub LinkCodesToNames( StringIn$ )

' This function takes an input of language codes and links them with their names, by
' using the two language arrays, in the form "code = Language". No validation is done at
' this time.

Dim LangCode$
Dim LangPair$
Dim WorkString$
Dim i As Integer, j As Integer, p As Integer

WorkString$ = Trim$( StringIn$ )
If WorkString$ = "" Then
    TempArrayElements% = 0
    ReDim TempArray( TempArrayElements% )
    Exit Sub
End If

' Remove any introduced double spaces, as the function proceeds in four-character
' increments, and extra spacing will throw things off.

Do
  p = InStr( WorkString$, "  " )
  If p <> 0 Then
      WorkString$ = Left$( WorkString$, p - 1 ) & Mid$( WorkString$, p + 1 )
  End If
Loop Until p = 0

' Get all the three-character strings at every fourth position in the whole string.

TempArrayElements% = ( ( Len( WorkString$ ) + 1 ) / 4 ) - 1
ReDim TempArray( TempArrayElements% )
p = 0

For i = 1 To Len( Trim$( WorkString$ ) ) Step 4
  LangCode$ = Mid$( WorkString$, i, 3 )

' Go through the array and get the name that matches the code, glue it to the code with
' the equals sign, and fill the intermediate array for later filling of the specific
' subfield array.

  For j = 1 To LANGUAGE_CODES_COUNT
    If LanguageCodes( j ) = LangCode$ Then
        LangPair$      = LangCode$ & " = " & LanguageNames( j )
        TempArray( p ) = LangPair$
        Exit For
    End If
  Next j
  If LangPair$ = "" Then
      LangPair$      = LangCode$ & " = Unknown"
      TempArray( p ) = LangPair$
  End If
  LangPair$ = ""
  p         = p + 1
Next i

End Sub
'****************************************************************************************
Sub SetLanguageArrays

' This routine fills the arrays for help in adding language codes. Codes and names are
' from MARC Code List for Languages, 2007 Edition, at <http://www.loc.gov/marc/languages/
' langhome.html>. The list was generated by manipulation of the code sequence (HTML),
' <http://www.loc.gov/marc/languages/language_code.html>, although the order of entries
' is by name. Discontinued codes are not included. Languages assigned a group code only
' are also excluded. The list does not include tracings or references (their addition
' would expand the list from under 500 entries to over 6000!). All terms current as of 11
' June 2010.

LanguageCodes( 0 )   = ""    : LanguageNames( 0 )   = "  - - - Select a language - - -  "
LanguageCodes( 1 )   = "abk" : LanguageNames( 1 )   = "Abkhaz"
LanguageCodes( 2 )   = "ace" : LanguageNames( 2 )   = "Achinese"
LanguageCodes( 3 )   = "ach" : LanguageNames( 3 )   = "Acoli"
LanguageCodes( 4 )   = "ada" : LanguageNames( 4 )   = "Adangme"
LanguageCodes( 5 )   = "ady" : LanguageNames( 5 )   = "Adygei"
LanguageCodes( 6 )   = "aar" : LanguageNames( 6 )   = "Afar"
LanguageCodes( 7 )   = "afh" : LanguageNames( 7 )   = "Afrihili (Artificial language)"
LanguageCodes( 8 )   = "afr" : LanguageNames( 8 )   = "Afrikaans"
LanguageCodes( 9 )   = "afa" : LanguageNames( 9 )   = "Afroasiatic (Other)"
LanguageCodes( 10 )  = "ain" : LanguageNames( 10 )  = "Ainu"
LanguageCodes( 11 )  = "aka" : LanguageNames( 11 )  = "Akan"
LanguageCodes( 12 )  = "akk" : LanguageNames( 12 )  = "Akkadian"
LanguageCodes( 13 )  = "alb" : LanguageNames( 13 )  = "Albanian"
LanguageCodes( 14 )  = "ale" : LanguageNames( 14 )  = "Aleut"
LanguageCodes( 15 )  = "alg" : LanguageNames( 15 )  = "Algonquian (Other)"
LanguageCodes( 16 )  = "alt" : LanguageNames( 16 )  = "Altai"
LanguageCodes( 17 )  = "tut" : LanguageNames( 17 )  = "Altaic (Other)"
LanguageCodes( 18 )  = "amh" : LanguageNames( 18 )  = "Amharic"
LanguageCodes( 19 )  = "anp" : LanguageNames( 19 )  = "Angika"
LanguageCodes( 20 )  = "apa" : LanguageNames( 20 )  = "Apache languages"
LanguageCodes( 21 )  = "ara" : LanguageNames( 21 )  = "Arabic"
LanguageCodes( 22 )  = "arg" : LanguageNames( 22 )  = "Aragonese"
LanguageCodes( 23 )  = "arc" : LanguageNames( 23 )  = "Aramaic"
LanguageCodes( 24 )  = "arp" : LanguageNames( 24 )  = "Arapaho"
LanguageCodes( 25 )  = "arw" : LanguageNames( 25 )  = "Arawak"
LanguageCodes( 26 )  = "arm" : LanguageNames( 26 )  = "Armenian"
LanguageCodes( 27 )  = "rup" : LanguageNames( 27 )  = "Aromanian"
LanguageCodes( 28 )  = "art" : LanguageNames( 28 )  = "Artificial (Other)"
LanguageCodes( 29 )  = "asm" : LanguageNames( 29 )  = "Assamese"
LanguageCodes( 30 )  = "ath" : LanguageNames( 30 )  = "Athapascan (Other)"
LanguageCodes( 31 )  = "aus" : LanguageNames( 31 )  = "Australian languages"
LanguageCodes( 32 )  = "map" : LanguageNames( 32 )  = "Austronesian (Other)"
LanguageCodes( 33 )  = "ava" : LanguageNames( 33 )  = "Avaric"
LanguageCodes( 34 )  = "ave" : LanguageNames( 34 )  = "Avestan"
LanguageCodes( 35 )  = "awa" : LanguageNames( 35 )  = "Awadhi"
LanguageCodes( 36 )  = "aym" : LanguageNames( 36 )  = "Aymara"
LanguageCodes( 37 )  = "aze" : LanguageNames( 37 )  = "Azerbaijani"
LanguageCodes( 38 )  = "ast" : LanguageNames( 38 )  = "Bable"
LanguageCodes( 39 )  = "ban" : LanguageNames( 39 )  = "Balinese"
LanguageCodes( 40 )  = "bat" : LanguageNames( 40 )  = "Baltic (Other)"
LanguageCodes( 41 )  = "bal" : LanguageNames( 41 )  = "Baluchi"
LanguageCodes( 42 )  = "bam" : LanguageNames( 42 )  = "Bambara"
LanguageCodes( 43 )  = "bai" : LanguageNames( 43 )  = "Bamileke languages"
LanguageCodes( 44 )  = "bad" : LanguageNames( 44 )  = "Banda languages"
LanguageCodes( 45 )  = "bnt" : LanguageNames( 45 )  = "Bantu (Other)"
LanguageCodes( 46 )  = "bas" : LanguageNames( 46 )  = "Basa"
LanguageCodes( 47 )  = "bak" : LanguageNames( 47 )  = "Bashkir"
LanguageCodes( 48 )  = "baq" : LanguageNames( 48 )  = "Basque"
LanguageCodes( 49 )  = "btk" : LanguageNames( 49 )  = "Batak"
LanguageCodes( 50 )  = "bej" : LanguageNames( 50 )  = "Beja"
LanguageCodes( 51 )  = "bel" : LanguageNames( 51 )  = "Belarusian"
LanguageCodes( 52 )  = "bem" : LanguageNames( 52 )  = "Bemba"
LanguageCodes( 53 )  = "ben" : LanguageNames( 53 )  = "Bengali"
LanguageCodes( 54 )  = "ber" : LanguageNames( 54 )  = "Berber (Other)"
LanguageCodes( 55 )  = "bho" : LanguageNames( 55 )  = "Bhojpuri"
LanguageCodes( 56 )  = "bih" : LanguageNames( 56 )  = "Bihari"
LanguageCodes( 57 )  = "bik" : LanguageNames( 57 )  = "Bikol"
LanguageCodes( 58 )  = "byn" : LanguageNames( 58 )  = "Bilin"
LanguageCodes( 59 )  = "bis" : LanguageNames( 59 )  = "Bislama"
LanguageCodes( 60 )  = "zbl" : LanguageNames( 60 )  = "Blissymbolics"
LanguageCodes( 61 )  = "bos" : LanguageNames( 61 )  = "Bosnian"
LanguageCodes( 62 )  = "bra" : LanguageNames( 62 )  = "Braj"
LanguageCodes( 63 )  = "bre" : LanguageNames( 63 )  = "Breton"
LanguageCodes( 64 )  = "bug" : LanguageNames( 64 )  = "Bugis"
LanguageCodes( 65 )  = "bul" : LanguageNames( 65 )  = "Bulgarian"
LanguageCodes( 66 )  = "bua" : LanguageNames( 66 )  = "Buriat"
LanguageCodes( 67 )  = "bur" : LanguageNames( 67 )  = "Burmese"
LanguageCodes( 68 )  = "cad" : LanguageNames( 68 )  = "Caddo"
LanguageCodes( 69 )  = "car" : LanguageNames( 69 )  = "Carib"
LanguageCodes( 70 )  = "cat" : LanguageNames( 70 )  = "Catalan"
LanguageCodes( 71 )  = "cau" : LanguageNames( 71 )  = "Caucasian (Other)"
LanguageCodes( 72 )  = "ceb" : LanguageNames( 72 )  = "Cebuano"
LanguageCodes( 73 )  = "cel" : LanguageNames( 73 )  = "Celtic (Other)"
LanguageCodes( 74 )  = "cai" : LanguageNames( 74 )  = "Central American Indian (Other)"
LanguageCodes( 75 )  = "chg" : LanguageNames( 75 )  = "Chagatai"
LanguageCodes( 76 )  = "cmc" : LanguageNames( 76 )  = "Chamic languages"
LanguageCodes( 77 )  = "cha" : LanguageNames( 77 )  = "Chamorro"
LanguageCodes( 78 )  = "che" : LanguageNames( 78 )  = "Chechen"
LanguageCodes( 79 )  = "chr" : LanguageNames( 79 )  = "Cherokee"
LanguageCodes( 80 )  = "chy" : LanguageNames( 80 )  = "Cheyenne"
LanguageCodes( 81 )  = "chb" : LanguageNames( 81 )  = "Chibcha"
LanguageCodes( 82 )  = "chi" : LanguageNames( 82 )  = "Chinese"
LanguageCodes( 83 )  = "chn" : LanguageNames( 83 )  = "Chinook jargon"
LanguageCodes( 84 )  = "chp" : LanguageNames( 84 )  = "Chipewyan"
LanguageCodes( 85 )  = "cho" : LanguageNames( 85 )  = "Choctaw"
LanguageCodes( 86 )  = "chu" : LanguageNames( 86 )  = "Church Slavic"
LanguageCodes( 87 )  = "chk" : LanguageNames( 87 )  = "Chuukese"
LanguageCodes( 88 )  = "chv" : LanguageNames( 88 )  = "Chuvash"
LanguageCodes( 89 )  = "cop" : LanguageNames( 89 )  = "Coptic"
LanguageCodes( 90 )  = "cor" : LanguageNames( 90 )  = "Cornish"
LanguageCodes( 91 )  = "cos" : LanguageNames( 91 )  = "Corsican"
LanguageCodes( 92 )  = "cre" : LanguageNames( 92 )  = "Cree"
LanguageCodes( 93 )  = "mus" : LanguageNames( 93 )  = "Creek"
LanguageCodes( 94 )  = "crp" : LanguageNames( 94 )  = "Creoles and Pidgins (Other)"
LanguageCodes( 95 )  = "cpe" : LanguageNames( 95 )  = "Creoles and Pidgins, English-based (Other)"
LanguageCodes( 96 )  = "cpf" : LanguageNames( 96 )  = "Creoles and Pidgins, French-based (Other)"
LanguageCodes( 97 )  = "cpp" : LanguageNames( 97 )  = "Creoles and Pidgins, Portuguese-based (Other)"
LanguageCodes( 98 )  = "crh" : LanguageNames( 98 )  = "Crimean Tatar"
LanguageCodes( 99 )  = "hrv" : LanguageNames( 99 )  = "Croatian"
LanguageCodes( 100 ) = "cus" : LanguageNames( 100 ) = "Cushitic (Other)"
LanguageCodes( 101 ) = "cze" : LanguageNames( 101 ) = "Czech"
LanguageCodes( 102 ) = "dak" : LanguageNames( 102 ) = "Dakota"
LanguageCodes( 103 ) = "dan" : LanguageNames( 103 ) = "Danish"
LanguageCodes( 104 ) = "dar" : LanguageNames( 104 ) = "Dargwa"
LanguageCodes( 105 ) = "day" : LanguageNames( 105 ) = "Dayak"
LanguageCodes( 106 ) = "del" : LanguageNames( 106 ) = "Delaware"
LanguageCodes( 107 ) = "din" : LanguageNames( 107 ) = "Dinka"
LanguageCodes( 108 ) = "div" : LanguageNames( 108 ) = "Divehi"
LanguageCodes( 109 ) = "doi" : LanguageNames( 109 ) = "Dogri"
LanguageCodes( 110 ) = "dgr" : LanguageNames( 110 ) = "Dogrib"
LanguageCodes( 111 ) = "dra" : LanguageNames( 111 ) = "Dravidian (Other)"
LanguageCodes( 112 ) = "dua" : LanguageNames( 112 ) = "Duala"
LanguageCodes( 113 ) = "dut" : LanguageNames( 113 ) = "Dutch"
LanguageCodes( 114 ) = "dum" : LanguageNames( 114 ) = "Dutch, Middle (ca. 1050-1350)"
LanguageCodes( 115 ) = "dyu" : LanguageNames( 115 ) = "Dyula"
LanguageCodes( 116 ) = "dzo" : LanguageNames( 116 ) = "Dzongkha"
LanguageCodes( 117 ) = "frs" : LanguageNames( 117 ) = "East Frisian"
LanguageCodes( 118 ) = "bin" : LanguageNames( 118 ) = "Edo"
LanguageCodes( 119 ) = "efi" : LanguageNames( 119 ) = "Efik"
LanguageCodes( 120 ) = "egy" : LanguageNames( 120 ) = "Egyptian"
LanguageCodes( 121 ) = "eka" : LanguageNames( 121 ) = "Ekajuk"
LanguageCodes( 122 ) = "elx" : LanguageNames( 122 ) = "Elamite"
LanguageCodes( 123 ) = "eng" : LanguageNames( 123 ) = "English"
LanguageCodes( 124 ) = "enm" : LanguageNames( 124 ) = "English, Middle (1100-1500)"
LanguageCodes( 125 ) = "ang" : LanguageNames( 125 ) = "English, Old (ca. 450-1100)"
LanguageCodes( 126 ) = "myv" : LanguageNames( 126 ) = "Erzya"
LanguageCodes( 127 ) = "epo" : LanguageNames( 127 ) = "Esperanto"
LanguageCodes( 128 ) = "est" : LanguageNames( 128 ) = "Estonian"
LanguageCodes( 129 ) = "gez" : LanguageNames( 129 ) = "Ethiopic"
LanguageCodes( 130 ) = "ewe" : LanguageNames( 130 ) = "Ewe"
LanguageCodes( 131 ) = "ewo" : LanguageNames( 131 ) = "Ewondo"
LanguageCodes( 132 ) = "fan" : LanguageNames( 132 ) = "Fang"
LanguageCodes( 133 ) = "fat" : LanguageNames( 133 ) = "Fanti"
LanguageCodes( 134 ) = "fao" : LanguageNames( 134 ) = "Faroese"
LanguageCodes( 135 ) = "fij" : LanguageNames( 135 ) = "Fijian"
LanguageCodes( 136 ) = "fil" : LanguageNames( 136 ) = "Filipino"
LanguageCodes( 137 ) = "fin" : LanguageNames( 137 ) = "Finnish"
LanguageCodes( 138 ) = "fiu" : LanguageNames( 138 ) = "Finno-Ugrian (Other)"
LanguageCodes( 139 ) = "fon" : LanguageNames( 139 ) = "Fon"
LanguageCodes( 140 ) = "fre" : LanguageNames( 140 ) = "French"
LanguageCodes( 141 ) = "frm" : LanguageNames( 141 ) = "French, Middle (ca. 1300-1600)"
LanguageCodes( 142 ) = "fro" : LanguageNames( 142 ) = "French, Old (ca. 842-1300)"
LanguageCodes( 143 ) = "fry" : LanguageNames( 143 ) = "Frisian"
LanguageCodes( 144 ) = "fur" : LanguageNames( 144 ) = "Friulian"
LanguageCodes( 145 ) = "ful" : LanguageNames( 145 ) = "Fula"
LanguageCodes( 146 ) = "gaa" : LanguageNames( 146 ) = "G"
LanguageCodes( 147 ) = "glg" : LanguageNames( 147 ) = "Galician"
LanguageCodes( 148 ) = "lug" : LanguageNames( 148 ) = "Ganda"
LanguageCodes( 149 ) = "gay" : LanguageNames( 149 ) = "Gayo"
LanguageCodes( 150 ) = "gba" : LanguageNames( 150 ) = "Gbaya"
LanguageCodes( 151 ) = "geo" : LanguageNames( 151 ) = "Georgian"
LanguageCodes( 152 ) = "ger" : LanguageNames( 152 ) = "German"
LanguageCodes( 153 ) = "gmh" : LanguageNames( 153 ) = "German, Middle High (ca. 1050-1500)"
LanguageCodes( 154 ) = "goh" : LanguageNames( 154 ) = "German, Old High (ca. 750-1050)"
LanguageCodes( 155 ) = "gem" : LanguageNames( 155 ) = "Germanic (Other)"
LanguageCodes( 156 ) = "gil" : LanguageNames( 156 ) = "Gilbertese"
LanguageCodes( 157 ) = "gon" : LanguageNames( 157 ) = "Gondi"
LanguageCodes( 158 ) = "gor" : LanguageNames( 158 ) = "Gorontalo"
LanguageCodes( 159 ) = "got" : LanguageNames( 159 ) = "Gothic"
LanguageCodes( 160 ) = "grb" : LanguageNames( 160 ) = "Grebo"
LanguageCodes( 161 ) = "grc" : LanguageNames( 161 ) = "Greek, Ancient (to 1453)"
LanguageCodes( 162 ) = "gre" : LanguageNames( 162 ) = "Greek, Modern (1453- )"
LanguageCodes( 163 ) = "grn" : LanguageNames( 163 ) = "Guarani"
LanguageCodes( 164 ) = "guj" : LanguageNames( 164 ) = "Gujarati"
LanguageCodes( 165 ) = "gwi" : LanguageNames( 165 ) = "Gwich'in"
LanguageCodes( 166 ) = "hai" : LanguageNames( 166 ) = "Haida"
LanguageCodes( 167 ) = "hat" : LanguageNames( 167 ) = "Haitian French Creole"
LanguageCodes( 168 ) = "hau" : LanguageNames( 168 ) = "Hausa"
LanguageCodes( 169 ) = "haw" : LanguageNames( 169 ) = "Hawaiian"
LanguageCodes( 170 ) = "heb" : LanguageNames( 170 ) = "Hebrew"
LanguageCodes( 171 ) = "her" : LanguageNames( 171 ) = "Herero"
LanguageCodes( 172 ) = "hil" : LanguageNames( 172 ) = "Hiligaynon"
LanguageCodes( 173 ) = "hin" : LanguageNames( 173 ) = "Hindi"
LanguageCodes( 174 ) = "hmo" : LanguageNames( 174 ) = "Hiri Motu"
LanguageCodes( 175 ) = "hit" : LanguageNames( 175 ) = "Hittite"
LanguageCodes( 176 ) = "hmn" : LanguageNames( 176 ) = "Hmong"
LanguageCodes( 177 ) = "hun" : LanguageNames( 177 ) = "Hungarian"
LanguageCodes( 178 ) = "hup" : LanguageNames( 178 ) = "Hupa"
LanguageCodes( 179 ) = "iba" : LanguageNames( 179 ) = "Iban"
LanguageCodes( 180 ) = "ice" : LanguageNames( 180 ) = "Icelandic"
LanguageCodes( 181 ) = "ido" : LanguageNames( 181 ) = "Ido"
LanguageCodes( 182 ) = "ibo" : LanguageNames( 182 ) = "Igbo"
LanguageCodes( 183 ) = "ijo" : LanguageNames( 183 ) = "Ijo"
LanguageCodes( 184 ) = "ilo" : LanguageNames( 184 ) = "Iloko"
LanguageCodes( 185 ) = "smn" : LanguageNames( 185 ) = "Inari Sami"
LanguageCodes( 186 ) = "inc" : LanguageNames( 186 ) = "Indic (Other)"
LanguageCodes( 187 ) = "ine" : LanguageNames( 187 ) = "Indo-European (Other)"
LanguageCodes( 188 ) = "ind" : LanguageNames( 188 ) = "Indonesian"
LanguageCodes( 189 ) = "inh" : LanguageNames( 189 ) = "Ingush"
LanguageCodes( 190 ) = "ina" : LanguageNames( 190 ) = "Interlingua (International Auxiliary Language Association)"
LanguageCodes( 191 ) = "ile" : LanguageNames( 191 ) = "Interlingue"
LanguageCodes( 192 ) = "iku" : LanguageNames( 192 ) = "Inuktitut"
LanguageCodes( 193 ) = "ipk" : LanguageNames( 193 ) = "Inupiaq"
LanguageCodes( 194 ) = "ira" : LanguageNames( 194 ) = "Iranian (Other)"
LanguageCodes( 195 ) = "gle" : LanguageNames( 195 ) = "Irish"
LanguageCodes( 196 ) = "mga" : LanguageNames( 196 ) = "Irish, Middle (ca. 1100-1550)"
LanguageCodes( 197 ) = "sga" : LanguageNames( 197 ) = "Irish, Old (to 1100)"
LanguageCodes( 198 ) = "iro" : LanguageNames( 198 ) = "Iroquoian (Other)"
LanguageCodes( 199 ) = "ita" : LanguageNames( 199 ) = "Italian"
LanguageCodes( 200 ) = "jpn" : LanguageNames( 200 ) = "Japanese"
LanguageCodes( 201 ) = "jav" : LanguageNames( 201 ) = "Javanese"
LanguageCodes( 202 ) = "jrb" : LanguageNames( 202 ) = "Judeo-Arabic"
LanguageCodes( 203 ) = "jpr" : LanguageNames( 203 ) = "Judeo-Persian"
LanguageCodes( 204 ) = "kbd" : LanguageNames( 204 ) = "Kabardian"
LanguageCodes( 205 ) = "kab" : LanguageNames( 205 ) = "Kabyle"
LanguageCodes( 206 ) = "kac" : LanguageNames( 206 ) = "Kachin"
LanguageCodes( 207 ) = "kal" : LanguageNames( 207 ) = "Kaltdlisut"
LanguageCodes( 208 ) = "kam" : LanguageNames( 208 ) = "Kamba"
LanguageCodes( 209 ) = "kan" : LanguageNames( 209 ) = "Kannada"
LanguageCodes( 210 ) = "kau" : LanguageNames( 210 ) = "Kanuri"
LanguageCodes( 211 ) = "krc" : LanguageNames( 211 ) = "Karachay-Balkar"
LanguageCodes( 212 ) = "kaa" : LanguageNames( 212 ) = "Kara-Kalpak"
LanguageCodes( 213 ) = "krl" : LanguageNames( 213 ) = "Karelian"
LanguageCodes( 214 ) = "kar" : LanguageNames( 214 ) = "Karen languages"
LanguageCodes( 215 ) = "kas" : LanguageNames( 215 ) = "Kashmiri"
LanguageCodes( 216 ) = "csb" : LanguageNames( 216 ) = "Kashubian"
LanguageCodes( 217 ) = "kaw" : LanguageNames( 217 ) = "Kawi"
LanguageCodes( 218 ) = "kaz" : LanguageNames( 218 ) = "Kazakh"
LanguageCodes( 219 ) = "kha" : LanguageNames( 219 ) = "Khasi"
LanguageCodes( 220 ) = "khm" : LanguageNames( 220 ) = "Khmer"
LanguageCodes( 221 ) = "khi" : LanguageNames( 221 ) = "Khoisan (Other)"
LanguageCodes( 222 ) = "kho" : LanguageNames( 222 ) = "Khotanese"
LanguageCodes( 223 ) = "kik" : LanguageNames( 223 ) = "Kikuyu"
LanguageCodes( 224 ) = "kmb" : LanguageNames( 224 ) = "Kimbundu"
LanguageCodes( 225 ) = "kin" : LanguageNames( 225 ) = "Kinyarwanda"
LanguageCodes( 226 ) = "tlh" : LanguageNames( 226 ) = "Klingon (Artificial language)"
LanguageCodes( 227 ) = "kom" : LanguageNames( 227 ) = "Komi"
LanguageCodes( 228 ) = "kon" : LanguageNames( 228 ) = "Kongo"
LanguageCodes( 229 ) = "kok" : LanguageNames( 229 ) = "Konkani"
LanguageCodes( 230 ) = "kut" : LanguageNames( 230 ) = "Kootenai"
LanguageCodes( 231 ) = "kor" : LanguageNames( 231 ) = "Korean"
LanguageCodes( 232 ) = "kpe" : LanguageNames( 232 ) = "Kpelle"
LanguageCodes( 233 ) = "kro" : LanguageNames( 233 ) = "Kru (Other)"
LanguageCodes( 234 ) = "kua" : LanguageNames( 234 ) = "Kuanyama"
LanguageCodes( 235 ) = "kum" : LanguageNames( 235 ) = "Kumyk"
LanguageCodes( 236 ) = "kur" : LanguageNames( 236 ) = "Kurdish"
LanguageCodes( 237 ) = "kru" : LanguageNames( 237 ) = "Kurukh"
LanguageCodes( 238 ) = "kos" : LanguageNames( 238 ) = "Kusaie"
LanguageCodes( 239 ) = "kir" : LanguageNames( 239 ) = "Kyrgyz"
LanguageCodes( 240 ) = "lad" : LanguageNames( 240 ) = "Ladino"
LanguageCodes( 241 ) = "lah" : LanguageNames( 241 ) = "Lahnd?"
LanguageCodes( 242 ) = "lam" : LanguageNames( 242 ) = "Lamba (Zambia and Congo)"
LanguageCodes( 243 ) = "lao" : LanguageNames( 243 ) = "Lao"
LanguageCodes( 244 ) = "lat" : LanguageNames( 244 ) = "Latin"
LanguageCodes( 245 ) = "lav" : LanguageNames( 245 ) = "Latvian"
LanguageCodes( 246 ) = "lez" : LanguageNames( 246 ) = "Lezgian"
LanguageCodes( 247 ) = "lim" : LanguageNames( 247 ) = "Limburgish"
LanguageCodes( 248 ) = "lin" : LanguageNames( 248 ) = "Lingala"
LanguageCodes( 249 ) = "lit" : LanguageNames( 249 ) = "Lithuanian"
LanguageCodes( 250 ) = "jbo" : LanguageNames( 250 ) = "Lojban (Artificial language)"
LanguageCodes( 251 ) = "nds" : LanguageNames( 251 ) = "Low German"
LanguageCodes( 252 ) = "dsb" : LanguageNames( 252 ) = "Lower Sorbian"
LanguageCodes( 253 ) = "loz" : LanguageNames( 253 ) = "Lozi"
LanguageCodes( 254 ) = "lub" : LanguageNames( 254 ) = "Luba-Katanga"
LanguageCodes( 255 ) = "lua" : LanguageNames( 255 ) = "Luba-Lulua"
LanguageCodes( 256 ) = "lui" : LanguageNames( 256 ) = "Luiseo"
LanguageCodes( 257 ) = "smj" : LanguageNames( 257 ) = "Lule Sami"
LanguageCodes( 258 ) = "lun" : LanguageNames( 258 ) = "Lunda"
LanguageCodes( 259 ) = "luo" : LanguageNames( 259 ) = "Luo (Kenya and Tanzania)"
LanguageCodes( 260 ) = "lus" : LanguageNames( 260 ) = "Lushai"
LanguageCodes( 261 ) = "ltz" : LanguageNames( 261 ) = "Luxembourgish"
LanguageCodes( 262 ) = "mac" : LanguageNames( 262 ) = "Macedonian"
LanguageCodes( 263 ) = "mad" : LanguageNames( 263 ) = "Madurese"
LanguageCodes( 264 ) = "mag" : LanguageNames( 264 ) = "Magahi"
LanguageCodes( 265 ) = "mai" : LanguageNames( 265 ) = "Maithili"
LanguageCodes( 266 ) = "mak" : LanguageNames( 266 ) = "Makasar"
LanguageCodes( 267 ) = "mlg" : LanguageNames( 267 ) = "Malagasy"
LanguageCodes( 268 ) = "may" : LanguageNames( 268 ) = "Malay"
LanguageCodes( 269 ) = "mal" : LanguageNames( 269 ) = "Malayalam"
LanguageCodes( 270 ) = "mlt" : LanguageNames( 270 ) = "Maltese"
LanguageCodes( 271 ) = "mnc" : LanguageNames( 271 ) = "Manchu"
LanguageCodes( 272 ) = "mdr" : LanguageNames( 272 ) = "Mandar"
LanguageCodes( 273 ) = "man" : LanguageNames( 273 ) = "Mandingo"
LanguageCodes( 274 ) = "mni" : LanguageNames( 274 ) = "Manipuri"
LanguageCodes( 275 ) = "mno" : LanguageNames( 275 ) = "Manobo languages"
LanguageCodes( 276 ) = "glv" : LanguageNames( 276 ) = "Manx"
LanguageCodes( 277 ) = "mao" : LanguageNames( 277 ) = "Maori"
LanguageCodes( 278 ) = "arn" : LanguageNames( 278 ) = "Mapuche"
LanguageCodes( 279 ) = "mar" : LanguageNames( 279 ) = "Marathi"
LanguageCodes( 280 ) = "chm" : LanguageNames( 280 ) = "Mari"
LanguageCodes( 281 ) = "mah" : LanguageNames( 281 ) = "Marshallese"
LanguageCodes( 282 ) = "mwr" : LanguageNames( 282 ) = "Marwari"
LanguageCodes( 283 ) = "mas" : LanguageNames( 283 ) = "Masai"
LanguageCodes( 284 ) = "myn" : LanguageNames( 284 ) = "Mayan languages"
LanguageCodes( 285 ) = "men" : LanguageNames( 285 ) = "Mende"
LanguageCodes( 286 ) = "mic" : LanguageNames( 286 ) = "Micmac"
LanguageCodes( 287 ) = "min" : LanguageNames( 287 ) = "Minangkabau"
LanguageCodes( 288 ) = "mwl" : LanguageNames( 288 ) = "Mirandese"
LanguageCodes( 289 ) = "mis" : LanguageNames( 289 ) = "Miscellaneous languages"
LanguageCodes( 290 ) = "moh" : LanguageNames( 290 ) = "Mohawk"
LanguageCodes( 291 ) = "mdf" : LanguageNames( 291 ) = "Moksha"
LanguageCodes( 292 ) = "mon" : LanguageNames( 292 ) = "Mongolian"
LanguageCodes( 293 ) = "lol" : LanguageNames( 293 ) = "Mongo-Nkundu"
LanguageCodes( 294 ) = "mkh" : LanguageNames( 294 ) = "Mon-Khmer (Other)"
LanguageCodes( 295 ) = "mos" : LanguageNames( 295 ) = "Moor"
LanguageCodes( 296 ) = "mul" : LanguageNames( 296 ) = "Multiple languages"
LanguageCodes( 297 ) = "mun" : LanguageNames( 297 ) = "Munda (Other)"
LanguageCodes( 298 ) = "nah" : LanguageNames( 298 ) = "Nahuatl"
LanguageCodes( 299 ) = "nau" : LanguageNames( 299 ) = "Nauru"
LanguageCodes( 300 ) = "nav" : LanguageNames( 300 ) = "Navajo"
LanguageCodes( 301 ) = "nbl" : LanguageNames( 301 ) = "Ndebele (South Africa)"
LanguageCodes( 302 ) = "nde" : LanguageNames( 302 ) = "Ndebele (Zimbabwe)"
LanguageCodes( 303 ) = "ndo" : LanguageNames( 303 ) = "Ndonga"
LanguageCodes( 304 ) = "nap" : LanguageNames( 304 ) = "Neapolitan Italian"
LanguageCodes( 305 ) = "nep" : LanguageNames( 305 ) = "Nepali"
LanguageCodes( 306 ) = "new" : LanguageNames( 306 ) = "Newari"
LanguageCodes( 307 ) = "nwc" : LanguageNames( 307 ) = "Newari, Old"
LanguageCodes( 308 ) = "nia" : LanguageNames( 308 ) = "Nias"
LanguageCodes( 309 ) = "nic" : LanguageNames( 309 ) = "Niger-Kordofanian (Other)"
LanguageCodes( 310 ) = "ssa" : LanguageNames( 310 ) = "Nilo-Saharan (Other)"
LanguageCodes( 311 ) = "niu" : LanguageNames( 311 ) = "Niuean"
LanguageCodes( 312 ) = "nqo" : LanguageNames( 312 ) = "N'Ko"
LanguageCodes( 313 ) = "zxx" : LanguageNames( 313 ) = "No linguistic content"
LanguageCodes( 314 ) = "nog" : LanguageNames( 314 ) = "Nogai"
LanguageCodes( 315 ) = "nai" : LanguageNames( 315 ) = "North American Indian (Other)"
LanguageCodes( 316 ) = "frr" : LanguageNames( 316 ) = "North Frisian"
LanguageCodes( 317 ) = "sme" : LanguageNames( 317 ) = "Northern Sami"
LanguageCodes( 318 ) = "nso" : LanguageNames( 318 ) = "Northern Sotho"
LanguageCodes( 319 ) = "nor" : LanguageNames( 319 ) = "Norwegian"
LanguageCodes( 320 ) = "nob" : LanguageNames( 320 ) = "Norwegian (Bokml)"
LanguageCodes( 321 ) = "nno" : LanguageNames( 321 ) = "Norwegian (Nynorsk)"
LanguageCodes( 322 ) = "nub" : LanguageNames( 322 ) = "Nubian languages"
LanguageCodes( 323 ) = "nym" : LanguageNames( 323 ) = "Nyamwezi"
LanguageCodes( 324 ) = "nya" : LanguageNames( 324 ) = "Nyanja"
LanguageCodes( 325 ) = "nyn" : LanguageNames( 325 ) = "Nyankole"
LanguageCodes( 326 ) = "nyo" : LanguageNames( 326 ) = "Nyoro"
LanguageCodes( 327 ) = "nzi" : LanguageNames( 327 ) = "Nzima"
LanguageCodes( 328 ) = "oci" : LanguageNames( 328 ) = "Occitan (post 1500)"
LanguageCodes( 329 ) = "xal" : LanguageNames( 329 ) = "Oirat"
LanguageCodes( 330 ) = "oji" : LanguageNames( 330 ) = "Ojibwa"
LanguageCodes( 331 ) = "non" : LanguageNames( 331 ) = "Old Norse"
LanguageCodes( 332 ) = "peo" : LanguageNames( 332 ) = "Old Persian (ca. 600-400 B.C.)"
LanguageCodes( 333 ) = "ori" : LanguageNames( 333 ) = "Oriya"
LanguageCodes( 334 ) = "orm" : LanguageNames( 334 ) = "Oromo"
LanguageCodes( 335 ) = "osa" : LanguageNames( 335 ) = "Osage"
LanguageCodes( 336 ) = "oss" : LanguageNames( 336 ) = "Ossetic"
LanguageCodes( 337 ) = "oto" : LanguageNames( 337 ) = "Otomian languages"
LanguageCodes( 338 ) = "pal" : LanguageNames( 338 ) = "Pahlavi"
LanguageCodes( 339 ) = "pau" : LanguageNames( 339 ) = "Palauan"
LanguageCodes( 340 ) = "pli" : LanguageNames( 340 ) = "Pali"
LanguageCodes( 341 ) = "pam" : LanguageNames( 341 ) = "Pampanga"
LanguageCodes( 342 ) = "pag" : LanguageNames( 342 ) = "Pangasinan"
LanguageCodes( 343 ) = "pan" : LanguageNames( 343 ) = "Panjabi"
LanguageCodes( 344 ) = "pap" : LanguageNames( 344 ) = "Papiamento"
LanguageCodes( 345 ) = "paa" : LanguageNames( 345 ) = "Papuan (Other)"
LanguageCodes( 346 ) = "per" : LanguageNames( 346 ) = "Persian"
LanguageCodes( 347 ) = "phi" : LanguageNames( 347 ) = "Philippine (Other)"
LanguageCodes( 348 ) = "phn" : LanguageNames( 348 ) = "Phoenician"
LanguageCodes( 349 ) = "pol" : LanguageNames( 349 ) = "Polish"
LanguageCodes( 350 ) = "pon" : LanguageNames( 350 ) = "Ponape"
LanguageCodes( 351 ) = "por" : LanguageNames( 351 ) = "Portuguese"
LanguageCodes( 352 ) = "pra" : LanguageNames( 352 ) = "Prakrit languages"
LanguageCodes( 353 ) = "pro" : LanguageNames( 353 ) = "Provenal (to 1500)"
LanguageCodes( 354 ) = "pus" : LanguageNames( 354 ) = "Pushto"
LanguageCodes( 355 ) = "que" : LanguageNames( 355 ) = "Quechua"
LanguageCodes( 356 ) = "roh" : LanguageNames( 356 ) = "Raeto-Romance"
LanguageCodes( 357 ) = "raj" : LanguageNames( 357 ) = "Rajasthani"
LanguageCodes( 358 ) = "rap" : LanguageNames( 358 ) = "Rapanui"
LanguageCodes( 359 ) = "rar" : LanguageNames( 359 ) = "Rarotongan"
LanguageCodes( 360 ) = "roa" : LanguageNames( 360 ) = "Romance (Other)"
LanguageCodes( 361 ) = "rom" : LanguageNames( 361 ) = "Romani"
LanguageCodes( 362 ) = "rum" : LanguageNames( 362 ) = "Romanian"
LanguageCodes( 363 ) = "run" : LanguageNames( 363 ) = "Rundi"
LanguageCodes( 364 ) = "rus" : LanguageNames( 364 ) = "Russian"
LanguageCodes( 365 ) = "sal" : LanguageNames( 365 ) = "Salishan languages"
LanguageCodes( 366 ) = "sam" : LanguageNames( 366 ) = "Samaritan Aramaic"
LanguageCodes( 367 ) = "smi" : LanguageNames( 367 ) = "Sami"
LanguageCodes( 368 ) = "smo" : LanguageNames( 368 ) = "Samoan"
LanguageCodes( 369 ) = "sad" : LanguageNames( 369 ) = "Sandawe"
LanguageCodes( 370 ) = "sag" : LanguageNames( 370 ) = "Sango (Ubangi Creole)"
LanguageCodes( 371 ) = "san" : LanguageNames( 371 ) = "Sanskrit"
LanguageCodes( 372 ) = "sat" : LanguageNames( 372 ) = "Santali"
LanguageCodes( 373 ) = "srd" : LanguageNames( 373 ) = "Sardinian"
LanguageCodes( 374 ) = "sas" : LanguageNames( 374 ) = "Sasak"
LanguageCodes( 375 ) = "sco" : LanguageNames( 375 ) = "Scots"
LanguageCodes( 376 ) = "gla" : LanguageNames( 376 ) = "Scottish Gaelic"
LanguageCodes( 377 ) = "sel" : LanguageNames( 377 ) = "Selkup"
LanguageCodes( 378 ) = "sem" : LanguageNames( 378 ) = "Semitic (Other)"
LanguageCodes( 379 ) = "srp" : LanguageNames( 379 ) = "Serbian"
LanguageCodes( 380 ) = "srr" : LanguageNames( 380 ) = "Serer"
LanguageCodes( 381 ) = "shn" : LanguageNames( 381 ) = "Shan"
LanguageCodes( 382 ) = "sna" : LanguageNames( 382 ) = "Shona"
LanguageCodes( 383 ) = "iii" : LanguageNames( 383 ) = "Sichuan Yi"
LanguageCodes( 384 ) = "scn" : LanguageNames( 384 ) = "Sicilian Italian"
LanguageCodes( 385 ) = "sid" : LanguageNames( 385 ) = "Sidamo"
LanguageCodes( 386 ) = "sgn" : LanguageNames( 386 ) = "Sign languages"
LanguageCodes( 387 ) = "bla" : LanguageNames( 387 ) = "Siksika"
LanguageCodes( 388 ) = "snd" : LanguageNames( 388 ) = "Sindhi"
LanguageCodes( 389 ) = "sin" : LanguageNames( 389 ) = "Sinhalese"
LanguageCodes( 390 ) = "sit" : LanguageNames( 390 ) = "Sino-Tibetan (Other)"
LanguageCodes( 391 ) = "sio" : LanguageNames( 391 ) = "Siouan (Other)"
LanguageCodes( 392 ) = "sms" : LanguageNames( 392 ) = "Skolt Sami"
LanguageCodes( 393 ) = "den" : LanguageNames( 393 ) = "Slave"
LanguageCodes( 394 ) = "sla" : LanguageNames( 394 ) = "Slavic (Other)"
LanguageCodes( 395 ) = "slo" : LanguageNames( 395 ) = "Slovak"
LanguageCodes( 396 ) = "slv" : LanguageNames( 396 ) = "Slovenian"
LanguageCodes( 397 ) = "sog" : LanguageNames( 397 ) = "Sogdian"
LanguageCodes( 398 ) = "som" : LanguageNames( 398 ) = "Somali"
LanguageCodes( 399 ) = "son" : LanguageNames( 399 ) = "Songhai"
LanguageCodes( 400 ) = "snk" : LanguageNames( 400 ) = "Soninke"
LanguageCodes( 401 ) = "wen" : LanguageNames( 401 ) = "Sorbian (Other)"
LanguageCodes( 402 ) = "sot" : LanguageNames( 402 ) = "Sotho"
LanguageCodes( 403 ) = "sai" : LanguageNames( 403 ) = "South American Indian (Other)"
LanguageCodes( 404 ) = "sma" : LanguageNames( 404 ) = "Southern Sami"
LanguageCodes( 405 ) = "spa" : LanguageNames( 405 ) = "Spanish"
LanguageCodes( 406 ) = "srn" : LanguageNames( 406 ) = "Sranan"
LanguageCodes( 407 ) = "suk" : LanguageNames( 407 ) = "Sukuma"
LanguageCodes( 408 ) = "sux" : LanguageNames( 408 ) = "Sumerian"
LanguageCodes( 409 ) = "sun" : LanguageNames( 409 ) = "Sundanese"
LanguageCodes( 410 ) = "sus" : LanguageNames( 410 ) = "Susu"
LanguageCodes( 411 ) = "swa" : LanguageNames( 411 ) = "Swahili"
LanguageCodes( 412 ) = "ssw" : LanguageNames( 412 ) = "Swazi"
LanguageCodes( 413 ) = "swe" : LanguageNames( 413 ) = "Swedish"
LanguageCodes( 414 ) = "gsw" : LanguageNames( 414 ) = "Swiss German"
LanguageCodes( 415 ) = "syc" : LanguageNames( 415 ) = "Syriac"
LanguageCodes( 416 ) = "syr" : LanguageNames( 416 ) = "Syriac, Modern"
LanguageCodes( 417 ) = "tgl" : LanguageNames( 417 ) = "Tagalog"
LanguageCodes( 418 ) = "tah" : LanguageNames( 418 ) = "Tahitian"
LanguageCodes( 419 ) = "tai" : LanguageNames( 419 ) = "Tai (Other)"
LanguageCodes( 420 ) = "tgk" : LanguageNames( 420 ) = "Tajik"
LanguageCodes( 421 ) = "tmh" : LanguageNames( 421 ) = "Tamashek"
LanguageCodes( 422 ) = "tam" : LanguageNames( 422 ) = "Tamil"
LanguageCodes( 423 ) = "tat" : LanguageNames( 423 ) = "Tatar"
LanguageCodes( 424 ) = "tel" : LanguageNames( 424 ) = "Telugu"
LanguageCodes( 425 ) = "tem" : LanguageNames( 425 ) = "Temne"
LanguageCodes( 426 ) = "ter" : LanguageNames( 426 ) = "Terena"
LanguageCodes( 427 ) = "tet" : LanguageNames( 427 ) = "Tetum"
LanguageCodes( 428 ) = "tha" : LanguageNames( 428 ) = "Thai"
LanguageCodes( 429 ) = "tib" : LanguageNames( 429 ) = "Tibetan"
LanguageCodes( 430 ) = "tig" : LanguageNames( 430 ) = "Tigr"
LanguageCodes( 431 ) = "tir" : LanguageNames( 431 ) = "Tigrinya"
LanguageCodes( 432 ) = "tiv" : LanguageNames( 432 ) = "Tiv"
LanguageCodes( 433 ) = "tli" : LanguageNames( 433 ) = "Tlingit"
LanguageCodes( 434 ) = "tpi" : LanguageNames( 434 ) = "Tok Pisin"
LanguageCodes( 435 ) = "tkl" : LanguageNames( 435 ) = "Tokelauan"
LanguageCodes( 436 ) = "tog" : LanguageNames( 436 ) = "Tonga (Nyasa)"
LanguageCodes( 437 ) = "ton" : LanguageNames( 437 ) = "Tongan"
LanguageCodes( 438 ) = "tsi" : LanguageNames( 438 ) = "Tsimshian"
LanguageCodes( 439 ) = "tso" : LanguageNames( 439 ) = "Tsonga"
LanguageCodes( 440 ) = "tsn" : LanguageNames( 440 ) = "Tswana"
LanguageCodes( 441 ) = "tum" : LanguageNames( 441 ) = "Tumbuka"
LanguageCodes( 442 ) = "tup" : LanguageNames( 442 ) = "Tupi languages"
LanguageCodes( 443 ) = "tur" : LanguageNames( 443 ) = "Turkish"
LanguageCodes( 444 ) = "ota" : LanguageNames( 444 ) = "Turkish, Ottoman"
LanguageCodes( 445 ) = "tuk" : LanguageNames( 445 ) = "Turkmen"
LanguageCodes( 446 ) = "tvl" : LanguageNames( 446 ) = "Tuvaluan"
LanguageCodes( 447 ) = "tyv" : LanguageNames( 447 ) = "Tuvinian"
LanguageCodes( 448 ) = "twi" : LanguageNames( 448 ) = "Twi"
LanguageCodes( 449 ) = "udm" : LanguageNames( 449 ) = "Udmurt"
LanguageCodes( 450 ) = "uga" : LanguageNames( 450 ) = "Ugaritic"
LanguageCodes( 451 ) = "uig" : LanguageNames( 451 ) = "Uighur"
LanguageCodes( 452 ) = "ukr" : LanguageNames( 452 ) = "Ukrainian"
LanguageCodes( 453 ) = "umb" : LanguageNames( 453 ) = "Umbundu"
LanguageCodes( 454 ) = "und" : LanguageNames( 454 ) = "Undetermined"
LanguageCodes( 455 ) = "hsb" : LanguageNames( 455 ) = "Upper Sorbian"
LanguageCodes( 456 ) = "urd" : LanguageNames( 456 ) = "Urdu"
LanguageCodes( 457 ) = "uzb" : LanguageNames( 457 ) = "Uzbek"
LanguageCodes( 458 ) = "vai" : LanguageNames( 458 ) = "Vai"
LanguageCodes( 459 ) = "ven" : LanguageNames( 459 ) = "Venda"
LanguageCodes( 460 ) = "vie" : LanguageNames( 460 ) = "Vietnamese"
LanguageCodes( 461 ) = "vol" : LanguageNames( 461 ) = "Volapk"
LanguageCodes( 462 ) = "vot" : LanguageNames( 462 ) = "Votic"
LanguageCodes( 463 ) = "wak" : LanguageNames( 463 ) = "Wakashan languages"
LanguageCodes( 464 ) = "wln" : LanguageNames( 464 ) = "Walloon"
LanguageCodes( 465 ) = "war" : LanguageNames( 465 ) = "Waray"
LanguageCodes( 466 ) = "was" : LanguageNames( 466 ) = "Washo"
LanguageCodes( 467 ) = "wel" : LanguageNames( 467 ) = "Welsh"
LanguageCodes( 468 ) = "him" : LanguageNames( 468 ) = "Western Pahari languages"
LanguageCodes( 469 ) = "wal" : LanguageNames( 469 ) = "Wolayta"
LanguageCodes( 470 ) = "wol" : LanguageNames( 470 ) = "Wolof"
LanguageCodes( 471 ) = "xho" : LanguageNames( 471 ) = "Xhosa"
LanguageCodes( 472 ) = "sah" : LanguageNames( 472 ) = "Yakut"
LanguageCodes( 473 ) = "yao" : LanguageNames( 473 ) = "Yao (Africa)"
LanguageCodes( 474 ) = "yap" : LanguageNames( 474 ) = "Yapese"
LanguageCodes( 475 ) = "yid" : LanguageNames( 475 ) = "Yiddish"
LanguageCodes( 476 ) = "yor" : LanguageNames( 476 ) = "Yoruba"
LanguageCodes( 477 ) = "ypk" : LanguageNames( 477 ) = "Yupik languages"
LanguageCodes( 478 ) = "znd" : LanguageNames( 478 ) = "Zande languages"
LanguageCodes( 479 ) = "zap" : LanguageNames( 479 ) = "Zapotec"
LanguageCodes( 480 ) = "zza" : LanguageNames( 480 ) = "Zaza"
LanguageCodes( 481 ) = "zen" : LanguageNames( 481 ) = "Zenaga"
LanguageCodes( 482 ) = "zha" : LanguageNames( 482 ) = "Zhuang"
LanguageCodes( 483 ) = "zul" : LanguageNames( 483 ) = "Zulu"
LanguageCodes( 484 ) = "zun" : LanguageNames( 484 ) = "Zuni"

End Sub
'****************************************************************************************
Sub SetupTextBoxes

' This sets up the initial text strings that display in the subfield boxes, drawn from
' master array "Subfields".

Subf1$  = Subfields( 0, aLANG_CODES_PRIMARY )
Subf2$  = Subfields( 1, aLANG_CODES_PRIMARY )
Subf3$  = Subfields( 2, aLANG_CODES_PRIMARY )
Subf4$  = Subfields( 3, aLANG_CODES_PRIMARY )
Subf5$  = Subfields( 4, aLANG_CODES_PRIMARY )
Subf6$  = Subfields( 5, aLANG_CODES_PRIMARY )
Subf7$  = Subfields( 6, aLANG_CODES_PRIMARY )
Subf1H$ = Subfields( 0, aLANG_CODES_ORIGS )
Subf2H$ = Subfields( 1, aLANG_CODES_ORIGS )
Subf3H$ = Subfields( 2, aLANG_CODES_ORIGS )
Subf4H$ = Subfields( 3, aLANG_CODES_ORIGS )
Subf5H$ = Subfields( 4, aLANG_CODES_ORIGS )
Subf6H$ = Subfields( 5, aLANG_CODES_ORIGS )
Subf7H$ = Subfields( 6, aLANG_CODES_ORIGS )
Subf1K$ = Subfields( 0, aLANG_CODES_INTERMS )
Subf2K$ = Subfields( 1, aLANG_CODES_INTERMS )
Subf3K$ = Subfields( 2, aLANG_CODES_INTERMS )
Subf4K$ = Subfields( 3, aLANG_CODES_INTERMS )
Subf5K$ = Subfields( 4, aLANG_CODES_INTERMS )
Subf6K$ = Subfields( 5, aLANG_CODES_INTERMS )
Subf7K$ = Subfields( 6, aLANG_CODES_INTERMS )

End Sub
'****************************************************************************************
Sub SetupCodeArrays

' This is the part of the macro that links language names to codes.

Dim i As Integer

LinkCodesToNames( Subf1$ )
ReDim CodesNames1( TempArrayElements% )
For i = 0 To TempArrayElements%
  CodesNames1( i ) = TempArray( i )
Next i

LinkCodesToNames( Subf1K$ )
ReDim CodesNames1K( TempArrayElements% )
For i = 0 To TempArrayElements%
  CodesNames1K( i ) = TempArray( i )
Next i

LinkCodesToNames( Subf1H$ )
ReDim CodesNames1H( TempArrayElements% )
For i = 0 To TempArrayElements%
  CodesNames1H( i ) = TempArray( i )
Next i

LinkCodesToNames( Subf2$ )
ReDim CodesNames2( TempArrayElements% )
For i = 0 To TempArrayElements%
  CodesNames2( i ) = TempArray( i )
Next i

LinkCodesToNames( Subf2K$ )
ReDim CodesNames2K( TempArrayElements% )
For i = 0 To TempArrayElements%
  CodesNames2K( i ) = TempArray( i )
Next i

LinkCodesToNames( Subf2H$ )
ReDim CodesNames2H( TempArrayElements% )
For i = 0 To TempArrayElements%
  CodesNames2H( i ) = TempArray( i )
Next i

LinkCodesToNames( Subf3$ )
ReDim CodesNames3( TempArrayElements% )
For i = 0 To TempArrayElements%
  CodesNames3( i ) = TempArray( i )
Next i

LinkCodesToNames( Subf3K$ )
ReDim CodesNames3K( TempArrayElements% )
For i = 0 To TempArrayElements%
  CodesNames3K( i ) = TempArray( i )
Next i

LinkCodesToNames( Subf3H$ )
ReDim CodesNames3H( TempArrayElements% )
For i = 0 To TempArrayElements%
  CodesNames3H( i ) = TempArray( i )
Next i

LinkCodesToNames( Subf4$ )
ReDim CodesNames4( TempArrayElements% )
For i = 0 To TempArrayElements%
  CodesNames4( i ) = TempArray( i )
Next i

LinkCodesToNames( Subf4K$ )
ReDim CodesNames4K( TempArrayElements% )
For i = 0 To TempArrayElements%
  CodesNames4K( i ) = TempArray( i )
Next i

LinkCodesToNames( Subf4H$ )
ReDim CodesNames4H( TempArrayElements% )
For i = 0 To TempArrayElements%
  CodesNames4H( i ) = TempArray( i )
Next i

LinkCodesToNames( Subf5$ )
ReDim CodesNames5( TempArrayElements% )
For i = 0 To TempArrayElements%
  CodesNames5( i ) = TempArray( i )
Next i

LinkCodesToNames( Subf5K$ )
ReDim CodesNames5K( TempArrayElements% )
For i = 0 To TempArrayElements%
  CodesNames5K( i ) = TempArray( i )
Next i

LinkCodesToNames( Subf5H$ )
ReDim CodesNames5H( TempArrayElements% )
For i = 0 To TempArrayElements%
  CodesNames5H( i ) = TempArray( i )
Next i

LinkCodesToNames( Subf6$ )
ReDim CodesNames6( TempArrayElements% )
For i = 0 To TempArrayElements%
  CodesNames6( i ) = TempArray( i )
Next i

LinkCodesToNames( Subf6K$ )
ReDim CodesNames6K( TempArrayElements% )
For i = 0 To TempArrayElements%
  CodesNames6K( i ) = TempArray( i )
Next i

LinkCodesToNames( Subf6H$ )
ReDim CodesNames6H( TempArrayElements% )
For i = 0 To TempArrayElements%
  CodesNames6H( i ) = TempArray( i )
Next i

LinkCodesToNames( Subf7$ )
ReDim CodesNames7( TempArrayElements% )
For i = 0 To TempArrayElements%
  CodesNames7( i ) = TempArray( i )
Next i

LinkCodesToNames( Subf7K$ )
ReDim CodesNames7K( TempArrayElements% )
For i = 0 To TempArrayElements%
  CodesNames7K( i ) = TempArray( i )
Next i

LinkCodesToNames( Subf7H$ )
ReDim CodesNames7H( TempArrayElements% )
For i = 0 To TempArrayElements%
  CodesNames7H( i ) = TempArray( i )
Next i

End Sub
'****************************************************************************************
Sub SwapDisplayListBox( SelectedTextBox% )

' When a subfield text box is clicked in, this routine displays its array of names.

Select Case SelectedTextBox%

  Case ID_FIRST_TEXT_BOX
    Subf1$          = Trim$( DlgText( "TextBox1" ) )
    DlgText         "TextBox1",         Subf1$
    DlgListBoxArray "SubfieldContents", CodesNames1()
    DlgText         "ListLegend",       ListLegendBase$ & "subfield $" & Subfields( 0, aSUBFIELD_CODE_PRIMARY ) & ":"

  Case ID_FIRST_TEXT_BOX + 1
    Subf1K$         = Trim$( DlgText( "TextBox1K" ) )
    DlgText         "TextBox1K",        Subf1K$
    DlgListBoxArray "SubfieldContents", CodesNames1K()
    DlgText         "ListLegend",       ListLegendBase$ & "selected subfield $k:"

  Case ID_FIRST_TEXT_BOX + 2
    Subf1H$         = Trim$( DlgText( "TextBox1H" ) )
    DlgText         "TextBox1H",        Subf1H$
    DlgListBoxArray "SubfieldContents", CodesNames1H()
    DlgText         "ListLegend",       ListLegendBase$ & "selected subfield $" & Subfields( 0, aSUBFIELD_CODE_ORIGS ) & ":"

  Case ID_FIRST_TEXT_BOX + 3
    Subf2$          = Trim$( DlgText( "TextBox2" ) )
    DlgText         "TextBox2",         Subf2$
    DlgListBoxArray "SubfieldContents", CodesNames2()
    DlgText         "ListLegend",       ListLegendBase$ & "subfield $" & Subfields( 1, aSUBFIELD_CODE_PRIMARY ) & ":"

  Case ID_FIRST_TEXT_BOX + 4
    Subf2K$         = Trim$( DlgText( "TextBox2K" ) )
    DlgText         "TextBox2K",        Subf2K$
    DlgListBoxArray "SubfieldContents", CodesNames2K()
    DlgText         "ListLegend",       ListLegendBase$ & "selected subfield $k:"

  Case ID_FIRST_TEXT_BOX + 5
    Subf2H$         = Trim$( DlgText( "TextBox2H" ) )
    DlgText         "TextBox2H",        Subf2H$
    DlgListBoxArray "SubfieldContents", CodesNames2H()
    DlgText         "ListLegend",       ListLegendBase$ & "selected subfield $" & Subfields( 1, aSUBFIELD_CODE_ORIGS ) & ":"

  Case ID_FIRST_TEXT_BOX + 6
    Subf3$          = Trim$( DlgText( "TextBox3" ) )
    DlgText         "TextBox3",         Subf3$
    DlgListBoxArray "SubfieldContents", CodesNames3()
    DlgText         "ListLegend",       ListLegendBase$ & "subfield $" & Subfields( 2, aSUBFIELD_CODE_PRIMARY ) & ":"

  Case ID_FIRST_TEXT_BOX + 7
    Subf3K$         = Trim$( DlgText( "TextBox3K" ) )
    DlgText         "TextBox3K",        Subf3K$
    DlgListBoxArray "SubfieldContents", CodesNames3K()
    DlgText         "ListLegend",       ListLegendBase$ & "selected subfield $k:"

  Case ID_FIRST_TEXT_BOX + 8
    Subf3H$         = Trim$( DlgText( "TextBox3H" ) )
    DlgText         "TextBox3H",        Subf3H$
    DlgListBoxArray "SubfieldContents", CodesNames3H()
    DlgText         "ListLegend",       ListLegendBase$ & "selected subfield $" & Subfields( 2, aSUBFIELD_CODE_ORIGS ) & ":"

  Case ID_FIRST_TEXT_BOX + 9
    Subf4$          = Trim$( DlgText( "TextBox4" ) )
    DlgText         "TextBox4",         Subf4$
    DlgListBoxArray "SubfieldContents", CodesNames4()
    DlgText         "ListLegend",       ListLegendBase$ & "subfield $" & Subfields( 3, aSUBFIELD_CODE_PRIMARY ) & ":"

  Case ID_FIRST_TEXT_BOX + 10
    Subf4K$         = Trim$( DlgText( "TextBox4K" ) )
    DlgText         "TextBox4K",        Subf4K$
    DlgListBoxArray "SubfieldContents", CodesNames4K()
    DlgText         "ListLegend",       ListLegendBase$ & "selected subfield $k:"

  Case ID_FIRST_TEXT_BOX + 11
    Subf4H$         = Trim$( DlgText( "TextBox4H" ) )
    DlgText         "TextBox4H",        Subf4H$
    DlgListBoxArray "SubfieldContents", CodesNames4H()
    DlgText         "ListLegend",       ListLegendBase$ & "selected subfield $" & Subfields( 3, aSUBFIELD_CODE_ORIGS ) & ":"

  Case ID_FIRST_TEXT_BOX + 12
    Subf5$          = Trim$( DlgText( "TextBox5" ) )
    DlgText         "TextBox5",         Subf5$
    DlgListBoxArray "SubfieldContents", CodesNames5()
    DlgText         "ListLegend",       ListLegendBase$ & "subfield $" & Subfields( 4, aSUBFIELD_CODE_PRIMARY ) & ":"

  Case ID_FIRST_TEXT_BOX + 13
    Subf5K$         = Trim$( DlgText( "TextBox5K" ) )
    DlgText         "TextBox5K",        Subf5K$
    DlgListBoxArray "SubfieldContents", CodesNames5K()
    DlgText         "ListLegend",       ListLegendBase$ & "selected subfield $k:"

  Case ID_FIRST_TEXT_BOX + 14
    Subf5H$         = Trim$( DlgText( "TextBox5H" ) )
    DlgText         "TextBox5H",        Subf5H$
    DlgListBoxArray "SubfieldContents", CodesNames5H()
    DlgText         "ListLegend",       ListLegendBase$ & "selected subfield $" & Subfields( 4, aSUBFIELD_CODE_ORIGS ) & ":"

  Case ID_FIRST_TEXT_BOX + 15
    Subf6$          = Trim$( DlgText( "TextBox6" ) )
    DlgText         "TextBox6",         Subf6$
    DlgListBoxArray "SubfieldContents", CodesNames6()
    DlgText         "ListLegend",       ListLegendBase$ & "subfield $" & Subfields( 5, aSUBFIELD_CODE_PRIMARY ) & ":"

  Case ID_FIRST_TEXT_BOX + 16
    Subf6K$         = Trim$( DlgText( "TextBox6K" ) )
    DlgText         "TextBox6K",        Subf6K$
    DlgListBoxArray "SubfieldContents", CodesNames6K()
    DlgText         "ListLegend",       ListLegendBase$ & "selected subfield $k:"

  Case ID_FIRST_TEXT_BOX + 17
    Subf6H$         = Trim$( DlgText( "TextBox6H" ) )
    DlgText         "TextBox6H",        Subf6H$
    DlgListBoxArray "SubfieldContents", CodesNames6H()
    DlgText         "ListLegend",       ListLegendBase$ & "selected subfield $" & Subfields( 5, aSUBFIELD_CODE_ORIGS ) & ":"

  Case ID_FIRST_TEXT_BOX + 18
    Subf7$          = Trim$( DlgText( "TextBox7" ) )
    DlgText         "TextBox7",         Subf7$
    DlgListBoxArray "SubfieldContents", CodesNames7()
    DlgText         "ListLegend",       ListLegendBase$ & "subfield $" & Subfields( 6, aSUBFIELD_CODE_PRIMARY ) & ":"

  Case ID_FIRST_TEXT_BOX + 19
    Subf7K$         = Trim$( DlgText( "TextBox7K" ) )
    DlgText         "TextBox7K",        Subf7K$
    DlgListBoxArray "SubfieldContents", CodesNames7K()
    DlgText         "ListLegend",       ListLegendBase$ & "selected subfield $k:"

  Case ID_FIRST_TEXT_BOX + 20
    Subf7H$         = Trim$( DlgText( "TextBox7H" ) )
    DlgText         "TextBox7H",        Subf7H$
    DlgListBoxArray "SubfieldContents", CodesNames7H()
    DlgText         "ListLegend",       ListLegendBase$ & "selected subfield $" & Subfields( 6, aSUBFIELD_CODE_ORIGS ) & ":"

End Select

End Sub
'****************************************************************************************
Function FormatSubfields( StringIn$, Code$ ) As String

' This function takes the string of codes entered into a subfield box in the dialog box
' and formats it for adding the field. Extra spaces are deleted, uppercase characters are
' made into lowercase, duplicate codes discarded, subfields $b, $f, and $j get their
' codes sorted into alphabetic order, and each code is placed into its own subfield.

Dim Candidate$
Dim Incumbent$
Dim Limit%
Dim TempString$
Dim WorkString$

Dim i As Integer, p As Integer, x As Integer

WorkString$ = Trim$( StringIn$ )

' Take out any double spaces.

Do
  p = InStr( WorkString$, "  " )
  If p <> 0 Then
      WorkString$ = Left$( WorkString$, p - 1 ) & Mid$( WorkString$, p + 1 )
  End If
Loop Until p = 0

' Eliminate duplicate language codes (validation does not check for duplicates), and for
' subfields $b, $f, and $j, sort the codes.

If Len( WorkString$ ) > LANG_CODE_LENGTH Then
    TempString$ = Left$( WorkString$, LANG_CODE_LENGTH )
    WorkString$ = Mid$( WorkString$, 5 )
    Do While Len( WorkString$) > 0
      Candidate$ = Left$( WorkString$, LANG_CODE_LENGTH )
      Limit%     = Len( TempString$ )
      For i = 1 To Limit% Step 4
        Incumbent$ = Mid$( TempString$, i, LANG_CODE_LENGTH )
        If Code$ = "b" Or Code$ = "f" Or Code$ = "j" Then
            x = StrComp( Candidate$, Incumbent$ )
            If x = STRING1_LESS_THAN Then
                If Len( TempString$ ) = LANG_CODE_LENGTH Then
                    TempString$ = Candidate$ & " " & TempString$
                  Else
                    TempString$ = Left$( TempString$, i - 1 ) & Candidate$ & " " & Mid$( TempString$, i )
                End If
                Change = TRUE
                Exit For
              ElseIf x = STRING1_EQUAL_TO Then
                Duplicates$ = Duplicates$ & Candidate$
                Exit For
              ElseIf i > Len( TempString$ ) - LANG_CODE_LENGTH Then
                TempString$ = TempString$ & " " & Candidate$
            End If
          Else
            x = InStr( TempString$, Candidate$ )
            If x = 0 Then
                TempString$ = TempString$ & " " & Candidate$
              Else
                Change = TRUE
            End If
            Exit For
        End If
      Next i
      WorkString$ = Mid$( WorkString$, 5 )
    Loop
  Else
    TempString$ = StringIn$
End If

If Update = FALSE Then

' If adding or replacing the field, put each language code into its own separate
' subfield. Otherwise, preserve the string of separate codes for redisplay.

    WorkString$ = ""
    i           = 1
    Do While i < Len( TempString$ )
      WorkString$ = WorkString$ & " " & DELIMITER & Code$ & " " & Mid$( TempString$, i, LANG_CODE_LENGTH )
      i           = i + 4
    Loop
  Else
    WorkString$ = TempString$
End If

' Finish up by making the string lowercase.

FormatSubfields = LCase$( Trim$( WorkString$ ) )

End Function
'****************************************************************************************
Function GetSubfieldCode( StringIn$ ) As String

' This function simply extracts the subfield code from the text box. The code is used to
' build a string representing the subfield structure of the 041 field to check for
' whether or not the item is a translation.

If Trim$( StringIn$ ) <> "" Then
    GetSubfieldCode = Mid$( StringIn$, 2, 1 )
  Else
    GetSubfieldCode = ""
End If

End Function
'****************************************************************************************
Function SplitCodeString( StringIn$, Code$, SortNeeded% ) As String

' This function takes multiple codes in a single, continuous string (e.g., "engfreita")
' and separates them ("eng fre ita"). As it does this it checks to see if they are in
' alphabetical order; if they aren't, it sets the flag to warn the main function. At the
' same time it keeps track of those subfields in order to display an explanatory note in
' the dialog box, because if the macro does nothing else, it will replace the field with
' the codes separated.

Dim NextCode$
Dim TempString$

Dim i As Integer

i = 1

StringIn$ = Trim$( StringIn$ )

If Len( StringIn$ ) > LANG_CODE_LENGTH Then
    Do While i < Len( StringIn$ )
      NextCode$    = Mid$( StringIn$, i, LANG_CODE_LENGTH )
      If StrComp( Right$( Trim$( TempString$ ), LANG_CODE_LENGTH ), NextCode$ ) =STRING1_GREATER_THAN Then
          SortNeeded% = 1
        Else
          If SortNeeded% = 0 Then
              SortNeeded% = 0
          End If
      End If
      TempString$  = TempString$ & NextCode$ & " "
      i            = i + LANG_CODE_LENGTH
    Loop
    Change         = TRUE
    MultipleCodes$ = MultipleCodes$ & Code$
  Else
    TempString$    = StringIn$
End If

SplitCodeString = Trim$( TempString$ )

End Function
'****************************************************************************************
Function ValidateInput( StringIn$ ) As String

' This function checks only that each language code is composed of exactly three letters,
' not that the codes themselves are valid.

Dim LenCode%
Dim TempCode$
Dim TempString$
Dim TestChar$

Dim i As Integer, j As Integer

Dim Problem                  : Problem = FALSE

TempString$ = Trim( StringIn$ )
If TempString$ = "" Then
    ValidateInput = ""
    Exit Function
End If

' Run through the string. Stop at every space (and, of course, at the end) to see if the
' preceding characters are three letters. If not, there's a problem. Characters entered
' in uppercase get fixed on replacement.

For i = 1 To Len( TempString$ )
  TestChar$ = Mid$( TempString$, i, 1 )
  If TestChar$ <> " " Then
      TempCode$ = TempCode$ & TestChar$
  End If
  If TestChar$ = " " Or i = Len( TempString$ ) Then
      LenCode% = Len( TempCode$ )
      If LenCode% > 0 And LenCode% <> LANG_CODE_LENGTH Then
          Problem = TRUE
          GoTo ProblemAction:
        ElseIf LenCode% = LANG_CODE_LENGTH Then
          For j = 1 To LANG_CODE_LENGTH
            TestChar$ = Mid$( TempCode$, j, 1 )
            If TestChar$ Like "[!A-Za-z]" Then
                Problem = TRUE
                GoTo ProblemAction:
            End If
          Next j
          If Problem = FALSE And i < Len( TempString$ ) Then
              TempCode$ = ""
          End If
      End If
  End If
Next i

' If the non-space character string is not three characters long, return it as the value
' of the function so it can be displayed.

ProblemAction:

If Len( TempCode$ ) <> LANG_CODE_LENGTH Or Problem = TRUE Then
    ValidateInput = TempCode$
    Exit Function
End If

ValidateInput = ""

End Function
'****************************************************************************************
Function Dialog1ControlFunction( Id$, Action%, SVal& )

If Action% = INITIALIZE Then DlgVisible      "Cancel", INVISIBLE

End Function
'****************************************************************************************
Function Dialog2ControlFunction( Id$, Action%, SVal& )

' This function controls the layout and behavior of the main dialog box and does some
' primitive entry validation.

Const ANSWER_NO      As Integer = 7   'The value returned by a message box when the "No" button is clicked.
Const CONTROL_CHANGE As Integer = 2   'The value of the dialog box function parameter "Action%" when a control changes.
Const FOCUS_CHANGE   As Integer = 4   'The value of the dialog box function parameter "Action%" when the control focus changes.
Const KEEP_DLG_OPEN  As Integer = -1  'The value of the dialog box function to keep a dialog box open.
Const SECOND_BUTTON  As Integer = 256 'The value to make the second button in a message box the default.
Const TEXTBOX_CHANGE As Integer = 3   'The value of the dialog box function parameter "Action%" when a change is made to to a textbox.
Const WARNING_QUERY  As Integer = 32  'The value to display the "Warning query" icon in a message box.
Const YES_NO         As Integer = 4   'The value to display "Yes" and "No" buttons in a message box.

Dim Answer%
Dim ChosenCode$
Dim FFLangRepl$
Dim InputProblem$
Dim MsgZxxInA$
Dim Target%
Dim TempMatch$
Dim TempString$
Dim TestChar$
Dim TranslationConflict$

Dim i As Integer, j As Integer, p As Integer

Dim Whoops                   : Whoops = FALSE

ChosenCode$          = LanguageCodes( DlgValue( "LanguageList" ) )
TranslationConflict$ = "There is at least one code for an original or intermediate language, but none for the translation language in subfield $"

Select Case Action%

  Case INITIALIZE

StartOver:

    Call InitializeDialog2Definition
    DlgText         "ListLegend",       ListLegendBase$ & "subfield $" & Subfields( 0, aSUBFIELD_CODE_PRIMARY ) & ":"

    Select Case FixLogicErrors%

      Case 0      'Reserving the possibility of displaying a "no problem" message
'        DlgVisible      "WarningText1",   VISIBLE
'        DlgText         "WarningText1",   "No problems with language coding in this record were detected."
        If FixLogicErrors% = 0 Or FixLogicErrors% = 3 Or FixLogicErrors% = 7 Then
            If FixCodingErrors% = 0 Then
                DlgVisible      "WarningBox",       INVISIBLE
              Else
                DlgVisible      "WarningBox",       VISIBLE
            End If
        End If

      Case WARN_SWITCH, WARN_SWITCH + WARN_MATCH    'Switch subfields $d and $a (takes priority over fixing mismatch)
        DlgVisible      "WarningText1",     VISIBLE
        DlgVisible      "WarningButton1",   VISIBLE
        DlgText         "WarningButton1",   "S&witch"
        DlgText         "WarningText1",     MsgSwitch$

      Case WARN_INSERT, WARN_INSERT + WARN_MATCH  'Insert subfield $a or $d first (takes priority over fixing mismatch)
        DlgVisible      "WarningText1",     VISIBLE
        DlgVisible      "WarningButton1",   VISIBLE
        DlgText         "WarningButton1",   "&Insert"
        DlgText         "WarningText1",     MsgInsert$

      Case WARN_MATCH                               'Language mismatch
        DlgVisible      "WarningText1",     VISIBLE
        DlgVisible      "WarningButton1",   VISIBLE
        DlgText         "WarningButton1",   "Fix &Lang"
        DlgText         "WarningText1",     MsgMatch$
        DlgVisible      "WarningButton2",   VISIBLE
        DlgText         "WarningButton2",   "Fix &041"
    End Select

    If SortCodesB And SortCodesF And SortCodesJ Then
        MsgSort$ = "Codes in subfields $b, $f, and $j will be sorted in alphabetical order."
      ElseIf SortCodesB And SortCodesF Then
        MsgSort$ = "Codes in subfields $b and $f will be sorted in alphabetical order."
      ElseIf SortCodesB And SortCodesJ Then
        MsgSort$ = "Codes in subfields $b and $j will be sorted in alphabetical order."
      ElseIf SortCodesF And SortCodesJ Then
        MsgSort$ = "Codes in subfields $f and $j will be sorted in alphabetical order."
      ElseIf SortCodesB Then
        MsgSort$ = "Codes in subfield $b will be sorted in alphabetical order."
      ElseIf SortCodesF Then
        MsgSort$ = "Codes in subfield $f will be sorted in alphabetical order."
      ElseIf SortCodesJ Then
        MsgSort$ = "Codes in subfield $j will be sorted in alphabetical order."
    End If

    Select Case FixCodingErrors%

      Case WARN_SORT
        If FixLogicErrors% = 0 Then
            DlgVisible      "WarningText2",     VISIBLE
            DlgText         "WarningText2",     MsgSort$
          Else
            DlgVisible      "WarningText3",     VISIBLE
            DlgText         "WarningText3",     MsgSort$
        End If

      Case WARN_SPLIT
        If FixLogicErrors% = 0 Then
            DlgVisible      "WarningText2",     VISIBLE
            DlgText         "WarningText2",     MsgSplit$
          Else
            DlgVisible      "WarningText3",     VISIBLE
            DlgText         "WarningText3",     MsgSplit$
        End If

      Case WARN_SPLIT + WARN_SORT
        If FixLogicErrors% = 0 Then
            DlgVisible      "WarningText2",     VISIBLE
            DlgText         "WarningText2",     MsgSplit$
            DlgVisible      "WarningText4",     VISIBLE
            DlgText         "WarningText4",     MsgSort$
          Else
            DlgVisible      "WarningText3",     VISIBLE
            DlgText         "WarningText3",     MsgSplit$
            DlgVisible      "WarningText5",     VISIBLE
            DlgText         "WarningText5",     MsgSort$
        End If

      Case WARN_DUPS
        If FixLogicErrors% = 0 Then
            DlgVisible      "WarningText2",     VISIBLE
            DlgText         "WarningText2",     MsgDups$
          Else
            DlgVisible      "WarningText3",     VISIBLE
            DlgText         "WarningText3",     MsgDups$
        End If

      Case WARN_SORT + WARN_DUPS
        If FixLogicErrors% = 0 Then
            DlgVisible      "WarningText2",     VISIBLE
            DlgText         "WarningText2",     MsgSort$
            DlgVisible      "WarningText4",     VISIBLE
            DlgText         "WarningText4",     MsgDups$
          Else
            DlgVisible      "WarningText3",     VISIBLE
            DlgText         "WarningText3",     MsgSort$
            DlgVisible      "WarningText5",     VISIBLE
            DlgText         "WarningText5",     MsgDups$
        End If

      Case WARN_SPLIT + WARN_DUPS
        If FixLogicErrors% = 0 Then
            DlgVisible      "WarningText2",     VISIBLE
            DlgText         "WarningText2",     MsgSplit$
            DlgVisible      "WarningText4",     VISIBLE
            DlgText         "WarningText4",     MsgDups$
          Else
            DlgVisible      "WarningText3",     VISIBLE
            DlgText         "WarningText3",     MsgSplit$
            DlgVisible      "WarningText5",     VISIBLE
            DlgText         "WarningText5",     MsgDups$
        End If

      Case WARN_SPLIT + WARN_SORT + WARN_DUPS
        If FixLogicErrors% = 0 Then
            DlgVisible      "WarningText2",     VISIBLE
            DlgText         "WarningText2",     MsgSplit$
            DlgVisible      "WarningText4",     VISIBLE
            DlgText         "WarningText4",     MsgSort$
            DlgVisible      "WarningText6",     VISIBLE
            DlgText         "WarningText6",     MsgDups$
          Else
            DlgVisible      "WarningText3",     VISIBLE
            DlgText         "WarningText3",     MsgSplit$
            DlgVisible      "WarningText5",     VISIBLE
            DlgText         "WarningText5",     MsgSort$
            DlgVisible      "WarningText7",     VISIBLE
            DlgText         "WarningText7",     MsgDups$
        End If
    End Select

    If Whoops = TRUE Or KeepDlgOpen = TRUE Then
        Dialog2ControlFunction = KEEP_DLG_OPEN
    End If

  Case CONTROL_CHANGE

    Select Case Id$

' When a language is selected from the drop-down list, there must be a subfield selected
' for the code to be added; if not, display a warning.

      Case "LanguageList"
        If PreviousControl% > ID_PRE_TEXT_BOXES and PreviousControl% < ID_POST_TEXT_BOXES Then
            Call AddLanguageCodeToBox( PreviousControl%, ChosenCode$, FROM_LANG_LIST )
        End If
        DlgValue        "LanguageList",     0
        Change     = TRUE

      Case "OK"

' When the "OK" button is pressed, check that each box contains only letters, and that
' there are no missing codes for languages of translation (that is, all language codes
' for original or intermediate languages of translation must follow codes for the
' ultimate language of translation).

        Subf1$  = Trim$( DlgText( "TextBox1"  ) )
        Subf1K$ = Trim$( DlgText( "TextBox1K" ) )
        Subf1H$ = Trim$( DlgText( "TextBox1H" ) )
        Subf2$  = Trim$( DlgText( "TextBox2"  ) )
        Subf2K$ = Trim$( DlgText( "TextBox2K" ) )
        Subf2H$ = Trim$( DlgText( "TextBox2H" ) )
        Subf3$  = Trim$( DlgText( "TextBox3"  ) )
        Subf3K$ = Trim$( DlgText( "TextBox3K" ) )
        Subf3H$ = Trim$( DlgText( "TextBox3H" ) )
        Subf4$  = Trim$( DlgText( "TextBox4"  ) )
        Subf4K$ = Trim$( DlgText( "TextBox4K" ) )
        Subf4H$ = Trim$( DlgText( "TextBox4H" ) )
        Subf5$  = Trim$( DlgText( "TextBox5"  ) )
        Subf5K$ = Trim$( DlgText( "TextBox5K" ) )
        Subf5H$ = Trim$( DlgText( "TextBox5H" ) )
        Subf6$  = Trim$( DlgText( "TextBox6"  ) )
        Subf6K$ = Trim$( DlgText( "TextBox6K" ) )
        Subf6H$ = Trim$( DlgText( "TextBox6H" ) )
        Subf7$  = Trim$( DlgText( "TextBox7"  ) )
        Subf7K$ = Trim$( DlgText( "TextBox7K" ) )
        Subf7H$ = Trim$( DlgText( "TextBox7H" ) )
        If Subf1$ = "" And ( Subf1K$ <> "" Or Subf1H$ <> "" ) Then
            If MsgBox( TranslationConflict$ & Subfields( 0, aSUBFIELD_CODE_PRIMARY ) & "! Continue?", WARNING_QUERY + SECOND_BUTTON + YES_NO, WaltsMacros$ ) = ANSWER_NO Then Exit Function
          ElseIf Subf2$ = "" And ( Subf2K$ <> "" Or Subf2H$ <> "" ) Then
            If MsgBox( TranslationConflict$ & Subfields( 1, aSUBFIELD_CODE_PRIMARY ) & "! Continue?", WARNING_QUERY + SECOND_BUTTON + YES_NO, WaltsMacros$ ) = ANSWER_NO Then Exit Function
          ElseIf Subf3$ = "" And ( Subf3K$ <> "" Or Subf3H$ <> "" ) Then
            If MsgBox( TranslationConflict$ & Subfields( 2, aSUBFIELD_CODE_PRIMARY ) & "! Continue?", WARNING_QUERY + SECOND_BUTTON + YES_NO, WaltsMacros$ ) = ANSWER_NO Then Exit Function
          ElseIf Subf4$ = "" And ( Subf4K$ <> "" Or Subf4H$ <> "" ) Then
            If MsgBox( TranslationConflict$ & Subfields( 3, aSUBFIELD_CODE_PRIMARY ) & "! Continue?", WARNING_QUERY + SECOND_BUTTON + YES_NO, WaltsMacros$ ) = ANSWER_NO Then Exit Function
          ElseIf Subf5$ = "" And ( Subf5K$ <> "" Or Subf5H$ <> "" ) Then
            If MsgBox( TranslationConflict$ & Subfields( 4, aSUBFIELD_CODE_PRIMARY ) & "! Continue?", WARNING_QUERY + SECOND_BUTTON + YES_NO, WaltsMacros$ ) = ANSWER_NO Then Exit Function
          ElseIf Subf6$ = "" And ( Subf6K$ <> "" Or Subf6H$ <> "" ) Then
            If MsgBox( TranslationConflict$ & Subfields( 5, aSUBFIELD_CODE_PRIMARY ) & "! Continue?", WARNING_QUERY + SECOND_BUTTON + YES_NO, WaltsMacros$ ) = ANSWER_NO Then Exit Function
          ElseIf Subf7$ = "" And ( Subf7K$ <> "" Or Subf7H$ <> "" ) Then
            If MsgBox( TranslationConflict$ & Subfields( 6, aSUBFIELD_CODE_PRIMARY ) & "! Continue?", WARNING_QUERY + SECOND_BUTTON + YES_NO, WaltsMacros$ ) = ANSWER_NO Then Exit Function
        End If
        If ValidateInput( Subf1$ ) <> "" Then
            InputProblem$ = Subfields( 0, aSUBFIELD_CODE_PRIMARY ) & ValidateInput( Subf1$ )
          ElseIf ValidateInput( Subf1K$ ) <> "" Then
            InputProblem$ = "k" & ValidateInput( Subf1K$ )
          ElseIf ValidateInput( Subf1H$ ) <> "" Then
            InputProblem$ = "h" & ValidateInput( Subf1H$ )
          ElseIf ValidateInput( Subf2$ ) <> "" Then
            InputProblem$ = Subfields( 1, aSUBFIELD_CODE_PRIMARY ) & ValidateInput( Subf2$ )
          ElseIf ValidateInput( Subf2K$ ) <> "" Then
            InputProblem$ = "k" & ValidateInput( Subf2K$ )
          ElseIf ValidateInput( Subf2H$ ) <> "" Then
            InputProblem$ = "h" & ValidateInput( Subf2H$ )
          ElseIf ValidateInput( Subf3$ ) <> "" Then
            InputProblem$ = Subfields( 2, aSUBFIELD_CODE_PRIMARY ) & ValidateInput( Subf3$ )
          ElseIf ValidateInput( Subf3K$ ) <> "" Then
            InputProblem$ = "k" & ValidateInput( Subf3K$ )
          ElseIf ValidateInput( Subf3H$ ) <> "" Then
            InputProblem$ = "h" & ValidateInput( Subf3H$ )
          ElseIf ValidateInput( Subf4$ ) <> "" Then
            InputProblem$ = Subfields( 3, aSUBFIELD_CODE_PRIMARY ) & ValidateInput( Subf4$ )
          ElseIf ValidateInput( Subf4K$ ) <> "" Then
            InputProblem$ = "k" & ValidateInput( Subf4K$ )
          ElseIf ValidateInput( Subf4H$ ) <> "" Then
            InputProblem$ = "h" & ValidateInput( Subf4H$ )
          ElseIf ValidateInput( Subf5$ ) <> "" Then
            InputProblem$ = Subfields( 4, aSUBFIELD_CODE_PRIMARY ) & ValidateInput( Subf5$ )
          ElseIf ValidateInput( Subf5K$ ) <> "" Then
            InputProblem$ = "k" & ValidateInput( Subf5K$ )
          ElseIf ValidateInput( Subf5H$ ) <> "" Then
            InputProblem$ = "h" & ValidateInput( Subf5H$ )
          ElseIf ValidateInput( Subf6$ ) <> "" Then
            InputProblem$ = Subfields( 5, aSUBFIELD_CODE_PRIMARY ) & ValidateInput( Subf6$ )
          ElseIf ValidateInput( Subf6K$ ) <> "" Then
            InputProblem$ = "k" & ValidateInput( Subf6K$ )
          ElseIf ValidateInput( Subf6H$ ) <> "" Then
            InputProblem$ = "h" & ValidateInput( Subf6H$ )
          ElseIf ValidateInput( Subf7$ ) <> "" Then
            InputProblem$ = Subfields( 6, aSUBFIELD_CODE_PRIMARY ) & ValidateInput( Subf7$ )
          ElseIf ValidateInput( Subf7K$ ) <> "" Then
            InputProblem$ = "k" & ValidateInput( Subf7K$ )
          ElseIf ValidateInput( Subf7H$ ) <> "" Then
            InputProblem$ = "h" & ValidateInput( Subf7H$ )
        End If
        If InputProblem$ <> "" Then
            MsgBox "Invalid code " & DOUBLE_QUOTE & Mid$( InputProblem$, 2 ) & DOUBLE_QUOTE & " in subfield $" & Left$( InputProblem$, 1 ) & "! Check input.", WARNING_MESSAGE, WaltsMacros$
            Dialog2ControlFunction = KEEP_DLG_OPEN
        End If

      Case "WarningButton1"
        Select Case FixLogicErrors%

' If the contents of subfields $a and $d need to be switched (e.g., a musical sound
' recording has the language coded in subfield $a rather than $d, or a film has the
' language coded in subfield $d rather than $a), this button swaps the labels of those
' two subfields, in effect turning one into the other.

          Case WARN_SWITCH, WARN_SWITCH + WARN_MATCH
            If FF_Type$ = "j" Then
                TempString$                                    = Subfields( PosSubfA%, aSUBFIELD_CODE_PRIMARY )
                Subfields( PosSubfA%, aSUBFIELD_CODE_PRIMARY ) = Subfields( PosSubfD%, aSUBFIELD_CODE_PRIMARY )
                Subfields( PosSubfD%, aSUBFIELD_CODE_PRIMARY ) = TempString$
                TempString$                                    = Subfields( PosSubfA%, aSUBFIELD_DEFN )
                Subfields( PosSubfA%, aSUBFIELD_DEFN )         = Subfields( PosSubfD%, aSUBFIELD_DEFN )
                Subfields( PosSubfD%, aSUBFIELD_DEFN )         = TempString$
              Else
                TempString$                                    = Subfields( PosSubfD%, aSUBFIELD_CODE_PRIMARY )
                Subfields( PosSubfD%, aSUBFIELD_CODE_PRIMARY ) = Subfields( PosSubfA%, aSUBFIELD_CODE_PRIMARY )
                Subfields( PosSubfA%, aSUBFIELD_CODE_PRIMARY ) = TempString$
                TempString$                                    = Subfields( PosSubfD%, aSUBFIELD_DEFN )
                Subfields( PosSubfD%, aSUBFIELD_DEFN )         = Subfields( PosSubfA%, aSUBFIELD_DEFN )
                Subfields( PosSubfA%, aSUBFIELD_DEFN )         = TempString$
            End If
            KeepDlgOpen = TRUE
            Change      = TRUE
            FixLogicErrors% = FixLogicErrors% - WARN_SWITCH
            GoTo StartOver:

' If neither subfield $a nor subfield $d is present, this button can quickly add one by
' taking the language code from the fixed field and inserting it as the first subfield.
' This is done by moving the appropriate element of the array to position 0 and sliding
' each subsequent element up to the next one.

          Case WARN_INSERT, WARN_INSERT + WARN_MATCH
            If FF_Type$ = "j" Then
                Target% = PosSubfD%
              Else
                Target% = PosSubfA%
            End If
            For i = Target% To 1 Step -1
              Subfields( i, aSUBFIELD_CODE_PRIMARY ) = Subfields( i - 1, aSUBFIELD_CODE_PRIMARY )
              Subfields( i, aLANG_CODES_PRIMARY )    = Subfields( i - 1, aLANG_CODES_PRIMARY )
              Subfields( i, aSUBFIELD_DEFN )         = Subfields( i - 1, aSUBFIELD_DEFN )
              Subfields( i, aLANG_CODES_INTERMS )    = Subfields( i - 1, aLANG_CODES_INTERMS )
              Subfields( i, aLANG_CODES_ORIGS )      = Subfields( i - 1, aLANG_CODES_ORIGS )
            Next i
            If FF_Type$ = "j" Then
                Subfields( 0, aSUBFIELD_CODE_PRIMARY ) = "d"
                Subfields( 0, aSUBFIELD_DEFN )         = "Language code of sung or spoken text"
              Else
                Subfields( 0, aSUBFIELD_CODE_PRIMARY ) = "a"
                Subfields( 0, aSUBFIELD_DEFN )         = "Language code of text/sound-track or separate title"
            End If
            Subfields( 0, aLANG_CODES_PRIMARY ) = FF_Lang$
            Subfields( 0, aLANG_CODES_ORIGS )   = ""
            Subfields( 0, aLANG_CODES_INTERMS ) = ""
            KeepDlgOpen = FALSE
            Change      = TRUE
            FixLogicErrors% = FixLogicErrors% - WARN_INSERT
            GoTo StartOver:

' The third option for this button is to quickly replace the language code in the fixed
' field with the first code in the 041.

         Case WARN_MATCH
            FFLangRepl$ = Left$( Subfields( 0, aLANG_CODES_PRIMARY ), LANG_CODE_LENGTH )
            If CS.SetFixedField( "Lang", FFLangRepl$ ) = FALSE Then
                MsgBox "Sorry, could not update the language code in the fixed field.", WARNING_MESSAGE, WaltsMacros$
              Else
                FF_Lang$ = FFLangRepl$
                If FF_Lang$ <> "999" Then
                    FFLangDisplay$ = TempArray( 0 )
                    FFLangDisplay$ = "Fixed field Lang: " & Trim$( FFLangDisplay$ )
                  Else
                    FFLangDisplay$ = "Fixed field Lang: [unavailable]"
                End If
                MsgBox "The code in " & DOUBLE_QUOTE & "Lang" & DOUBLE_QUOTE & " in the fixed field was changed!", INFORMATION_MESSAGE, WaltsMacros$
            End If
            Lang041Match = TRUE
            Whoops       = TRUE
            ChangeFF     = TRUE
            FixLogicErrors%  = FixLogicErrors% - WARN_MATCH
            GoTo StartOver:
        End Select

      Case "WarningButton2"

' If the 041 is to be fixed to match the language code in the fixed field, the fix
' depends upon whether or not the record is for a sound recording, as the type of record
' determines the first subfield in the field. If the first subfield is appropriate for
' the type of record, just insert the language code in the fixed field as the first code
' in the subfield. Otherwise, look for the appropriate code in "Subfields," make that and
' the associated elements the first subfield, and put in their place in the array the
' existing first subfield.

        If FF_Type$ = "j" Then
            If Subfields( 0, aSUBFIELD_CODE_PRIMARY ) = "d" Then
                p = InStr( Subf1$, FF_Lang$ )
                If p > 0 Then
                    TempMatch$ = Left$( Subf1$, p - 2 ) & Mid$( Subf1$, p + 3 )
                  Else
                    TempMatch$ = Subf1$
                End If
                Subf1$ = FF_Lang$ & " " & TempMatch$
                DlgText         "TextBox1",         Subf1$
              Else
                For i = 1 To aCOUNT_SUBFIELDS
                  TestChar$ = Subfields( i, aSUBFIELD_CODE_PRIMARY )
                  If TestChar$ = "d" Then
                      TempString$                            = Subfields( i, aSUBFIELD_CODE_PRIMARY )
                      Subfields( i, aSUBFIELD_CODE_PRIMARY ) = Subfields( 0, aSUBFIELD_CODE_PRIMARY )
                      Subfields( 0, aSUBFIELD_CODE_PRIMARY ) = TempString$
                      TempString$                            = Subfields( i, aLANG_CODES_PRIMARY )
                      Subfields( i, aLANG_CODES_PRIMARY )    = Subfields( 0, aLANG_CODES_PRIMARY )
                      Subfields( 0, aLANG_CODES_PRIMARY )    = FF_Lang$ & " " & TempString$
                      TempString$                            = Subfields( i, aSUBFIELD_DEFN )
                      Subfields( i, aSUBFIELD_DEFN )         = Subfields( 0, aSUBFIELD_DEFN )
                      Subfields( 0, aSUBFIELD_DEFN )         = TempString$
                      TempString$                            = Subfields( i, aLANG_CODES_ORIGS )
                      Subfields( i, aLANG_CODES_ORIGS )      = Subfields( 0, aLANG_CODES_ORIGS )
                      Subfields( 0, aLANG_CODES_ORIGS )      = TempString$
                  End If
                  Exit For
                Next i
            End If
          Else
            If Subfields( 0, aSUBFIELD_CODE_PRIMARY ) = "a" Then
                If FF_Lang$ = "zxx" Then
                    If FF_Type$ = "a" Then
                        If Subfields( 0, aLANG_CODES_PRIMARY ) <> "" Then
                            Answer% = MsgBox( "The language code " & DOUBLE_QUOTE & "zxx" & DOUBLE_QUOTE & " does not allow for subfield $a to be used! Do you want to clear subfield $a of all content?", 52, WaltsMacros$ )
                            If Answer% = 6 Then
                                Subfields( 0, aLANG_CODES_PRIMARY ) = ""
                              Else
                                FixLogicErrors% = FixLogicErrors% + WARN_MATCH
                            End If
                        End If
                      Else
                        MsgZxxInA$ = "Can't add code " & DOUBLE_QUOTE & "zxx" & DOUBLE_QUOTE & " to subfield $a! Click OK to replace contents of subfield $a with "
                        MsgZxxInA$ = MsgZxxInA$ & DOUBLE_QUOTE & "zxx" & DOUBLE_QUOTE & " , or Cancel to return to the dialog box."
                        Answer% = MsgBox( MsgZxxInA$, 33, WaltsMacros$ )
                        If Answer% = 1 Then
                            Subfields( 0, aLANG_CODES_PRIMARY ) = FF_Lang$
                          Else
                            FixLogicErrors% = FixLogicErrors% + WARN_MATCH
                        End If
                    End If
                    FixLogicErrors% = FixLogicErrors% - WARN_MATCH
                    KeepDlgOpen = TRUE
                    Change      = TRUE
                    GoTo StartOver:
                  Else
                    Subfields( 0, aLANG_CODES_PRIMARY ) = FF_Lang$ & " " & Subfields( 0, aLANG_CODES_PRIMARY )
                End If
              Else
                For i = 1 To aCOUNT_SUBFIELDS
                  TestChar$ = Subfields( i, aSUBFIELD_CODE_PRIMARY )
                  If TestChar$ = "a" Then
                      TempString$                            = Subfields( i, aSUBFIELD_CODE_PRIMARY )
                      Subfields( i, aSUBFIELD_CODE_PRIMARY ) = Subfields( 0, aSUBFIELD_CODE_PRIMARY )
                      Subfields( 0, aSUBFIELD_CODE_PRIMARY ) = TempString$
                      TempString$                            = Subfields( i, aLANG_CODES_PRIMARY )
                      Subfields( i, aLANG_CODES_PRIMARY )    = Subfields( 0, aLANG_CODES_PRIMARY )
                      Subfields( 0, aLANG_CODES_PRIMARY )    = FF_Lang$ & " " & TempString$
                      TempString$                            = Subfields( i, aSUBFIELD_DEFN )
                      Subfields( i, aSUBFIELD_DEFN )         = Subfields( 0, aSUBFIELD_DEFN )
                      Subfields( 0, aSUBFIELD_DEFN )         = TempString$
                      TempString$                            = Subfields( i, aLANG_CODES_ORIGS )
                      Subfields( i, aLANG_CODES_ORIGS )      = Subfields( 0, aLANG_CODES_ORIGS )
                      Subfields( 0, aLANG_CODES_ORIGS )      = TempString$
                  End If
                  Exit For
                Next i
            End If
        End If
        Lang041Match = TRUE
        Whoops       = TRUE
        Change       = TRUE
        FixLogicErrors%  = FixLogicErrors% - WARN_MATCH
        GoTo StartOver:

    End Select

  Case TEXTBOX_CHANGE

    Addition$ = DlgText( Id$ )
    If CurrentControl% < ID_FIRST_TEXT_BOX Or CurrentControl% > ID_LAST_TEXT_BOX Then
        CurrentControl% = ID_FIRST_TEXT_BOX
    End If
    If DlgFocus$() <> "Update" Then
        Call CompareBoxes( CurrentControl%, Addition$ )
    End If

  Case FOCUS_CHANGE

    DlgValue        "LanguageList",     0
    PreviousControl% = Int( SVal& )
    If PreviousControl% > ID_PRE_TEXT_BOXES And PreviousControl% < ID_POST_TEXT_BOXES Then
        InitialFocus%    = PreviousControl%
        PreviousTextbox% = PreviousControl%
    End If
    CurrentControl%    = DlgControlID( Id$ )
    If CurrentControl% < ID_FIRST_TEXT_BOX Or CurrentControl% > ID_LAST_TEXT_BOX Then
        CurrentControl% = PreviousTextbox%
    End If
    If CurrentControl% > ID_PRE_TEXT_BOXES And CurrentControl% < ID_POST_TEXT_BOXES Then
        Call SwapDisplayListBox( CurrentControl% )
    End If

End Select

End Function
'3480163581
'
'Macro name: Show041
'Macro book: C:\Program Files (x86)\OCLC\Connexion\Program\Macros\Extras1.mbk
'Saved: 12/17/2018 9:06:48 AM using "MacroBookInspector" macro by Walter F. Nickeson.
